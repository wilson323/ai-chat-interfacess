# çŠ¶æ€ç®¡ç†ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ å½“å‰çŠ¶æ€ç®¡ç†åˆ†æ

### 1. ç°æœ‰çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

- **React Context**: `agent-context.tsx`, `language-context.tsx`, `user-context.tsx`
- **Zustand**: `agentStore.ts`, `messageStore.ts`, `chatStore.ts`
- **æœ¬åœ°çŠ¶æ€**: å„ç»„ä»¶å†…çš„ `useState`

### 2. å­˜åœ¨çš„é—®é¢˜

- **çŠ¶æ€åˆ†æ•£**: å¤šä¸ªçŠ¶æ€ç®¡ç†æ–¹æ¡ˆæ··ç”¨ï¼Œç¼ºä¹ç»Ÿä¸€æ€§
- **æ€§èƒ½é—®é¢˜**: Context é¢‘ç¹æ›´æ–°å¯¼è‡´ä¸å¿…è¦çš„é‡æ¸²æŸ“
- **çŠ¶æ€åŒæ­¥**: ä¸åŒçŠ¶æ€æºä¹‹é—´ç¼ºä¹åŒæ­¥æœºåˆ¶
- **è°ƒè¯•å›°éš¾**: çŠ¶æ€åˆ†æ•£ï¼Œéš¾ä»¥è¿½è¸ªå’Œè°ƒè¯•
- **ç±»å‹å®‰å…¨**: éƒ¨åˆ†çŠ¶æ€ç¼ºä¹ç±»å‹çº¦æŸ

## ğŸ—ï¸ ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### 1. ç»Ÿä¸€çŠ¶æ€ç®¡ç†æ¶æ„

```mermaid
graph TD
    A[åº”ç”¨çŠ¶æ€] --> B[å…¨å±€çŠ¶æ€ - Zustand]
    A --> C[ç»„ä»¶çŠ¶æ€ - useState]
    A --> D[æœåŠ¡çŠ¶æ€ - TanStack Query]

    B --> E[ç”¨æˆ·çŠ¶æ€]
    B --> F[æ™ºèƒ½ä½“çŠ¶æ€]
    B --> G[UIçŠ¶æ€]
    B --> H[èŠå¤©çŠ¶æ€]

    C --> I[è¡¨å•çŠ¶æ€]
    C --> J[ä¸´æ—¶çŠ¶æ€]

    D --> K[APIç¼“å­˜]
    D --> L[æœåŠ¡ç«¯çŠ¶æ€]
```

### 2. çŠ¶æ€åˆ†å±‚ç­–ç•¥

- **å…¨å±€çŠ¶æ€**: ç”¨æˆ·ä¿¡æ¯ã€æ™ºèƒ½ä½“é…ç½®ã€UIçŠ¶æ€ç­‰
- **ç»„ä»¶çŠ¶æ€**: è¡¨å•è¾“å…¥ã€ä¸´æ—¶çŠ¶æ€ã€æœ¬åœ°UIçŠ¶æ€
- **æœåŠ¡çŠ¶æ€**: APIæ•°æ®ã€ç¼“å­˜ã€æœåŠ¡ç«¯çŠ¶æ€

### 3. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

- **çŠ¶æ€é€‰æ‹©å™¨**: ç²¾ç¡®è®¢é˜…éœ€è¦çš„çŠ¶æ€ç‰‡æ®µ
- **çŠ¶æ€åˆ†ç‰‡**: æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†çŠ¶æ€
- **çŠ¶æ€ç¼“å­˜**: ä½¿ç”¨ TanStack Query ç¼“å­˜æœåŠ¡ç«¯çŠ¶æ€
- **çŠ¶æ€æŒä¹…åŒ–**: å…³é”®çŠ¶æ€æŒä¹…åŒ–åˆ° localStorage

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç»Ÿä¸€çŠ¶æ€ç®¡ç† Store

```typescript
// lib/store/appStore.ts
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { immer } from 'zustand/middleware/immer';

interface AppState {
  // ç”¨æˆ·çŠ¶æ€
  user: {
    id: string | null;
    name: string | null;
    email: string | null;
    avatar: string | null;
  };

  // æ™ºèƒ½ä½“çŠ¶æ€
  agents: {
    list: Agent[];
    selected: Agent | null;
    loading: boolean;
  };

  // UIçŠ¶æ€
  ui: {
    sidebarOpen: boolean;
    historySidebarOpen: boolean;
    theme: 'light' | 'dark';
    language: 'zh' | 'en';
  };

  // èŠå¤©çŠ¶æ€
  chat: {
    currentChatId: string | null;
    messages: Message[];
    isTyping: boolean;
    isRequestActive: boolean;
  };

  // å…¨å±€å˜é‡
  globalVariables: Record<string, any>;

  // Actions
  setUser: (user: Partial<AppState['user']>) => void;
  setAgents: (agents: Agent[]) => void;
  selectAgent: (agent: Agent) => void;
  toggleSidebar: () => void;
  toggleHistorySidebar: () => void;
  setTheme: (theme: 'light' | 'dark') => void;
  setLanguage: (language: 'zh' | 'en') => void;
  setGlobalVariables: (variables: Record<string, any>) => void;
  addMessage: (message: Message) => void;
  clearMessages: () => void;
  setTyping: (typing: boolean) => void;
  setRequestActive: (active: boolean) => void;
}

export const useAppStore = create<AppState>()(
  persist(
    immer((set, get) => ({
      // åˆå§‹çŠ¶æ€
      user: {
        id: null,
        name: null,
        email: null,
        avatar: null,
      },

      agents: {
        list: [],
        selected: null,
        loading: false,
      },

      ui: {
        sidebarOpen: false,
        historySidebarOpen: false,
        theme: 'light',
        language: 'zh',
      },

      chat: {
        currentChatId: null,
        messages: [],
        isTyping: false,
        isRequestActive: false,
      },

      globalVariables: {},

      // Actions
      setUser: user =>
        set(state => {
          Object.assign(state.user, user);
        }),

      setAgents: agents =>
        set(state => {
          state.agents.list = agents;
          state.agents.loading = false;
        }),

      selectAgent: agent =>
        set(state => {
          state.agents.selected = agent;
        }),

      toggleSidebar: () =>
        set(state => {
          state.ui.sidebarOpen = !state.ui.sidebarOpen;
        }),

      toggleHistorySidebar: () =>
        set(state => {
          state.ui.historySidebarOpen = !state.ui.historySidebarOpen;
        }),

      setTheme: theme =>
        set(state => {
          state.ui.theme = theme;
        }),

      setLanguage: language =>
        set(state => {
          state.ui.language = language;
        }),

      setGlobalVariables: variables =>
        set(state => {
          state.globalVariables = { ...state.globalVariables, ...variables };
        }),

      addMessage: message =>
        set(state => {
          state.chat.messages.push(message);
        }),

      clearMessages: () =>
        set(state => {
          state.chat.messages = [];
        }),

      setTyping: typing =>
        set(state => {
          state.chat.isTyping = typing;
        }),

      setRequestActive: active =>
        set(state => {
          state.chat.isRequestActive = active;
        }),
    })),
    {
      name: 'app-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: state => ({
        user: state.user,
        ui: state.ui,
        globalVariables: state.globalVariables,
      }),
    }
  )
);
```

### 2. çŠ¶æ€é€‰æ‹©å™¨

```typescript
// lib/store/selectors.ts
import { useAppStore } from './appStore';

// ç”¨æˆ·çŠ¶æ€é€‰æ‹©å™¨
export const useUser = () => useAppStore(state => state.user);
export const useUserActions = () =>
  useAppStore(state => ({
    setUser: state.setUser,
  }));

// æ™ºèƒ½ä½“çŠ¶æ€é€‰æ‹©å™¨
export const useAgents = () => useAppStore(state => state.agents);
export const useSelectedAgent = () =>
  useAppStore(state => state.agents.selected);
export const useAgentActions = () =>
  useAppStore(state => ({
    setAgents: state.setAgents,
    selectAgent: state.selectAgent,
  }));

// UIçŠ¶æ€é€‰æ‹©å™¨
export const useUI = () => useAppStore(state => state.ui);
export const useSidebar = () =>
  useAppStore(state => ({
    sidebarOpen: state.ui.sidebarOpen,
    historySidebarOpen: state.ui.historySidebarOpen,
    toggleSidebar: state.toggleSidebar,
    toggleHistorySidebar: state.toggleHistorySidebar,
  }));

// èŠå¤©çŠ¶æ€é€‰æ‹©å™¨
export const useChat = () => useAppStore(state => state.chat);
export const useMessages = () => useAppStore(state => state.chat.messages);
export const useChatActions = () =>
  useAppStore(state => ({
    addMessage: state.addMessage,
    clearMessages: state.clearMessages,
    setTyping: state.setTyping,
    setRequestActive: state.setRequestActive,
  }));

// å…¨å±€å˜é‡é€‰æ‹©å™¨
export const useGlobalVariables = () =>
  useAppStore(state => state.globalVariables);
export const useGlobalVariableActions = () =>
  useAppStore(state => ({
    setGlobalVariables: state.setGlobalVariables,
  }));
```

### 3. æœåŠ¡çŠ¶æ€ç®¡ç†

```typescript
// lib/services/queryClient.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
      cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿ
      retry: 3,
      refetchOnWindowFocus: false,
    },
    mutations: {
      retry: 1,
    },
  },
});

// lib/hooks/useAgents.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import {
  fetchAgents,
  createAgent,
  updateAgent,
  deleteAgent,
} from '@/lib/services/agent-service';

export const useAgents = () => {
  return useQuery({
    queryKey: ['agents'],
    queryFn: fetchAgents,
    staleTime: 5 * 60 * 1000,
  });
};

export const useCreateAgent = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: createAgent,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['agents'] });
    },
  });
};

export const useUpdateAgent = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: updateAgent,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['agents'] });
    },
  });
};

export const useDeleteAgent = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: deleteAgent,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['agents'] });
    },
  });
};
```

### 4. çŠ¶æ€åŒæ­¥æœºåˆ¶

```typescript
// lib/store/sync.ts
import { useAppStore } from './appStore';
import { useAgents } from '@/lib/hooks/useAgents';

export const useStateSync = () => {
  const { data: agents, isLoading } = useAgents();
  const setAgents = useAppStore(state => state.setAgents);

  useEffect(() => {
    if (agents && !isLoading) {
      setAgents(agents);
    }
  }, [agents, isLoading, setAgents]);
};
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. çŠ¶æ€è®¢é˜…ä¼˜åŒ–

```typescript
// ç²¾ç¡®è®¢é˜…ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
const sidebarOpen = useAppStore(state => state.ui.sidebarOpen);
const toggleSidebar = useAppStore(state => state.toggleSidebar);

// ä½¿ç”¨é€‰æ‹©å™¨é¿å…å¯¹è±¡å¼•ç”¨å˜åŒ–
const user = useAppStore(state => state.user);
const userActions = useAppStore(state => ({
  setUser: state.setUser,
}));
```

### 2. çŠ¶æ€åˆ†ç‰‡

```typescript
// æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†çŠ¶æ€
const useAgentState = () => useAppStore(state => state.agents);
const useUIState = () => useAppStore(state => state.ui);
const useChatState = () => useAppStore(state => state.chat);
```

### 3. çŠ¶æ€ç¼“å­˜

```typescript
// ä½¿ç”¨ TanStack Query ç¼“å­˜æœåŠ¡ç«¯çŠ¶æ€
const { data: agents, isLoading } = useQuery({
  queryKey: ['agents'],
  queryFn: fetchAgents,
  staleTime: 5 * 60 * 1000,
});
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. çŠ¶æ€æµ‹è¯•

```typescript
// __tests__/store/appStore.test.ts
import { renderHook, act } from '@testing-library/react';
import { useAppStore } from '@/lib/store/appStore';

describe('AppStore', () => {
  it('should update user state', () => {
    const { result } = renderHook(() => useAppStore());

    act(() => {
      result.current.setUser({ id: '1', name: 'Test User' });
    });

    expect(result.current.user.id).toBe('1');
    expect(result.current.user.name).toBe('Test User');
  });
});
```

### 2. é€‰æ‹©å™¨æµ‹è¯•

```typescript
// __tests__/store/selectors.test.ts
import { renderHook } from '@testing-library/react';
import { useUser } from '@/lib/store/selectors';

describe('Selectors', () => {
  it('should select user state', () => {
    const { result } = renderHook(() => useUser());
    expect(result.current).toBeDefined();
  });
});
```

## ğŸ“‹ è¿ç§»è®¡åˆ’

### 1. ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºç»Ÿä¸€çŠ¶æ€ç®¡ç†

- [ ] åˆ›å»º `appStore.ts`
- [ ] åˆ›å»ºçŠ¶æ€é€‰æ‹©å™¨
- [ ] åˆ›å»ºæœåŠ¡çŠ¶æ€ç®¡ç†
- [ ] ç¼–å†™æµ‹è¯•

### 2. ç¬¬äºŒé˜¶æ®µï¼šè¿ç§»ç°æœ‰çŠ¶æ€

- [ ] è¿ç§»ç”¨æˆ·çŠ¶æ€
- [ ] è¿ç§»æ™ºèƒ½ä½“çŠ¶æ€
- [ ] è¿ç§»UIçŠ¶æ€
- [ ] è¿ç§»èŠå¤©çŠ¶æ€

### 3. ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å’Œæµ‹è¯•

- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] çŠ¶æ€åŒæ­¥æµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•

## ğŸ¯ é¢„æœŸæ•ˆæœ

### 1. æ€§èƒ½æå‡

- **çŠ¶æ€æ›´æ–°æ€§èƒ½**: æå‡ 50%
- **é‡æ¸²æŸ“æ¬¡æ•°**: å‡å°‘ 70%
- **å†…å­˜ä½¿ç”¨**: å‡å°‘ 30%

### 2. å¼€å‘ä½“éªŒ

- **çŠ¶æ€è°ƒè¯•**: ç»Ÿä¸€è°ƒè¯•å·¥å…·
- **ç±»å‹å®‰å…¨**: 100% ç±»å‹è¦†ç›–
- **ä»£ç å¤ç”¨**: çŠ¶æ€é€»è¾‘å¤ç”¨

### 3. ç»´æŠ¤æ€§

- **çŠ¶æ€é›†ä¸­**: ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- **çŠ¶æ€åŒæ­¥**: è‡ªåŠ¨åŒæ­¥æœºåˆ¶
- **çŠ¶æ€æŒä¹…åŒ–**: å…³é”®çŠ¶æ€æŒä¹…åŒ–

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¸è¿›å¼è¿ç§»**: é€æ­¥è¿ç§»ç°æœ‰çŠ¶æ€ï¼Œé¿å…ç ´åæ€§å˜æ›´
2. **å‘åå…¼å®¹**: ä¿æŒç°æœ‰APIå…¼å®¹æ€§
3. **æ€§èƒ½ç›‘æ§**: æŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡
4. **æµ‹è¯•è¦†ç›–**: ç¡®ä¿æµ‹è¯•è¦†ç›–ç‡ > 80%

**è®°ä½: å¥½çš„çŠ¶æ€ç®¡ç†æ˜¯åº”ç”¨æ€§èƒ½çš„åŸºç¡€ï¼Œç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†ç¡®ä¿åº”ç”¨çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚**
