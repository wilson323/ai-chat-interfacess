# 用户管理系统

## 概述

用户管理系统为 NeuroGlass AI Chat Interface 提供了完整的用户管理功能，包括用户创建、编辑、删除、角色分配和权限控制。

## 功能特性

### 🎯 核心功能

1. **用户列表管理**
   - 分页展示用户列表
   - 搜索和筛选功能
   - 批量操作支持
   - 状态快速切换

2. **用户创建与编辑**
   - 完整的表单验证
   - 密码安全设置
   - 角色和权限配置
   - 部门和联系方式

3. **权限管理**
   - 基于角色的权限控制
   - 细粒度权限分配
   - 权限预览和管理

4. **操作日志**
   - 完整的操作记录
   - IP地址和用户代理记录
   - 操作状态跟踪

### 🔧 技术特性

- **响应式设计**: 支持桌面端和移动端
- **实时搜索**: 支持用户名、邮箱、部门搜索
- **批量操作**: 支持激活、停用、暂停、删除等批量操作
- **状态管理**: 支持用户状态切换（激活/未激活/暂停）
- **安全控制**: 密码加密、权限验证、操作审计

## 角色与权限

### 角色定义

| 角色 | 描述 | 默认权限 |
|------|------|----------|
| 超级管理员 | 拥有所有系统权限 | 所有权限 |
| 管理员 | 可管理用户和系统配置 | 智能体管理、用户管理、数据导出、系统监控 |
| 操作员 | 可管理智能体和查看监控 | 智能体管理、系统监控 |
| 查看者 | 仅可查看系统信息 | 系统监控 |

### 权限列表

- **agent:manage**: 智能体管理
- **system:config**: 系统配置
- **user:manage**: 用户管理
- **data:export**: 数据导出
- **system:monitor**: 系统监控

## 数据库设计

### 用户表 (users)

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'viewer',
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  last_login TIMESTAMP,
  avatar VARCHAR(255),
  phone VARCHAR(20),
  department VARCHAR(100),
  permissions JSONB DEFAULT '[]',
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 操作日志表 (operation_logs)

```sql
CREATE TABLE operation_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id VARCHAR(50),
  details JSONB,
  ip_address VARCHAR(45),
  user_agent TEXT,
  status VARCHAR(20) DEFAULT 'success',
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## API 接口

### 用户列表

```http
GET /api/admin/users
```

**查询参数:**
- `page`: 页码 (默认: 1)
- `limit`: 每页数量 (默认: 10)
- `search`: 搜索关键词
- `role`: 角色筛选
- `status`: 状态筛选
- `department`: 部门筛选

**响应示例:**
```json
{
  \"success\": true,
  \"data\": {
    \"data\": [
      {
        \"id\": 1,
        \"username\": \"admin\",
        \"email\": \"admin@example.com\",
        \"role\": \"super_admin\",
        \"status\": \"active\",
        \"permissions\": [\"agent:manage\", \"system:config\"],
        \"createdAt\": \"2024-01-01T00:00:00.000Z\",
        \"updatedAt\": \"2024-01-01T00:00:00.000Z\"
      }
    ],
    \"pagination\": {
      \"page\": 1,
      \"limit\": 10,
      \"total\": 1,
      \"totalPages\": 1
    }
  }
}
```

### 创建用户

```http
POST /api/admin/users
```

**请求体:**
```json
{
  \"username\": \"newuser\",
  \"email\": \"newuser@example.com\",
  \"password\": \"password123\",
  \"role\": \"viewer\",
  \"status\": \"active\",
  \"permissions\": [\"system:monitor\"],
  \"department\": \"IT部门\",
  \"phone\": \"13800138000\"
}
```

### 更新用户

```http
PUT /api/admin/users/[id]
```

### 删除用户

```http
DELETE /api/admin/users/[id]
```

### 批量操作

```http
PUT /api/admin/users/bulk
```

**请求体:**
```json
{
  \"action\": \"activate\",
  \"userIds\": [1, 2, 3]
}
```

## 部署说明

### 1. 数据库迁移

运行数据库迁移来创建用户管理相关表：

```bash
# 运行迁移
npm run db:migrate
```

### 2. 默认管理员账户

系统会自动创建默认管理员账户：
- **用户名**: admin
- **密码**: admin123456

⚠️ **安全提醒**: 首次登录后请立即修改默认密码！

### 3. 权限配置

确保管理后台的中间件正确配置了权限验证：

```javascript
// 在 middleware.ts 中添加用户管理权限验证
export async function middleware(request: NextRequest) {
  // 检查管理员权限
  if (request.nextUrl.pathname.startsWith('/admin/users')) {
    const isAdmin = await checkAdminPermission(request);
    if (!isAdmin) {
      return NextResponse.redirect(new URL('/admin/login', request.url));
    }
  }
}
```

## 使用指南

### 1. 访问用户管理

1. 登录管理后台 (`/admin`)
2. 点击「用户管理」卡片
3. 进入用户管理页面 (`/admin/users`)

### 2. 创建用户

1. 点击「创建用户」按钮
2. 填写用户基本信息
3. 选择角色和权限
4. 设置密码（可选）
5. 点击「创建用户」

### 3. 管理用户

1. **编辑用户**: 点击用户操作菜单中的「编辑」
2. **查看详情**: 点击用户操作菜单中的「查看详情」
3. **状态切换**: 使用状态开关快速切换用户状态
4. **批量操作**: 选择多个用户后进行批量操作

### 4. 权限管理

1. **角色权限**: 选择角色会自动设置默认权限
2. **自定义权限**: 可以根据需要为用户分配额外权限
3. **权限预览**: 在表单中实时查看当前权限配置

## 安全注意事项

1. **密码安全**: 密码经过加密存储，符合安全标准
2. **权限验证**: 所有操作都需要管理员权限验证
3. **操作审计**: 所有用户操作都会记录到操作日志
4. **访问控制**: 基于角色的访问控制，确保数据安全

## 故障排除

### 常见问题

1. **无法访问用户管理页面**
   - 检查是否已登录管理后台
   - 确认是否有用户管理权限

2. **用户创建失败**
   - 检查用户名和邮箱是否已存在
   - 确认密码符合复杂度要求

3. **权限不生效**
   - 检查用户角色是否正确
   - 确认权限配置是否完整

### 日志查看

用户操作日志位于数据库 `operation_logs` 表中，包含：
- 操作时间
- 操作类型
- 操作用户
- IP地址
- 操作状态

## 更新日志

### v1.0.0 (2024-09-14)
- ✅ 完整的用户管理功能
- ✅ 基于角色的权限控制
- ✅ 操作日志记录
- ✅ 批量操作支持
- ✅ 响应式界面设计
- ✅ 完整的测试覆盖