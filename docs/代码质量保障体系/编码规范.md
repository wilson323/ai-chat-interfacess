# 项目编码规范 - 代码质量保障体系

## 1. TypeScript编码规范

### 1.1 基础配置

```typescript
// tsconfig.json 严格配置
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true
  }
}
```

### 1.2 命名规范

- **变量和函数**: camelCase
- **类名**: PascalCase
- **常量**: UPPER_SNAKE_CASE
- **接口**: PascalCase，以I开头
- **类型别名**: PascalCase
- **枚举**: PascalCase

### 1.3 导入导出规范

```typescript
// ✅ 正确：命名导出
export const userService = { ... };
export function validateUser() { ... };

// ❌ 错误：默认导出
export default userService;

// ✅ 正确：导入顺序
import React from 'react';
import { NextRequest } from 'next/server';
import { userService } from '@/lib/services';
import { Button } from '@/components/ui';
```

## 2. React/JSX编码规范

### 2.1 组件定义

```typescript
// ✅ 正确：函数组件
interface UserFormProps {
  userId: string;
  onSubmit: (data: UserData) => void;
}

export function UserForm({ userId, onSubmit }: UserFormProps) {
  // 组件逻辑
}
```

### 2.2 JSX特殊字符处理

```typescript
// ✅ 正确：使用JavaScript表达式
<label>响应时间 {'<'} 50ms</label>
<label>内存使用 {'<'} 100MB</label>

// ❌ 错误：直接使用特殊字符
<label>响应时间 < 50ms</label>

// ❌ 错误：HTML实体编码
<label>响应时间 &lt; 50ms</label>
```

### 2.3 事件处理

```typescript
// ✅ 正确：类型安全的事件处理
const handleSubmit = (event: React.FormEvent<HTMLFormElement>) => {
  event.preventDefault();
  // 处理逻辑
};

// ✅ 正确：异步事件处理
const handleAsyncSubmit = async (event: React.FormEvent) => {
  try {
    await submitData();
  } catch (error) {
    console.error('提交失败:', error);
  }
};
```

## 3. 错误处理规范

### 3.1 函数错误处理

```typescript
// ✅ 正确：完整的错误处理
export async function fetchUserData(userId: string): Promise<UserData | null> {
  try {
    const response = await fetch(`/api/users/${userId}`);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error('获取用户数据失败:', error);
    return null;
  }
}
```

### 3.2 组件错误处理

```typescript
// ✅ 正确：错误边界组件
export function ErrorBoundary({ children }: { children: React.ReactNode }) {
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    const handleError = (error: ErrorEvent) => {
      console.error('组件错误:', error);
      setHasError(true);
    };

    window.addEventListener('error', handleError);
    return () => window.removeEventListener('error', handleError);
  }, []);

  if (hasError) {
    return <div>出现错误，请刷新页面重试</div>;
  }

  return <>{children}</>;
}
```

## 4. 代码组织规范

### 4.1 文件结构

```
components/
  admin/
    user-management/
      user-form.tsx          # 组件文件
      user-form.test.tsx     # 测试文件
      user-form.types.ts     # 类型定义
      index.ts              # 导出文件
```

### 4.2 组件结构

```typescript
// 1. 导入语句
import React from 'react';
import { Button } from '@/components/ui';

// 2. 类型定义
interface ComponentProps {
  // 属性定义
}

// 3. 组件定义
export function Component({ ...props }: ComponentProps) {
  // 4. 状态定义
  const [state, setState] = useState();

  // 5. 副作用
  useEffect(() => {
    // 副作用逻辑
  }, []);

  // 6. 事件处理
  const handleEvent = () => {
    // 事件逻辑
  };

  // 7. 渲染
  return (
    <div>
      {/* JSX内容 */}
    </div>
  );
}
```

## 5. 性能优化规范

### 5.1 组件优化

```typescript
// ✅ 正确：使用React.memo
export const ExpensiveComponent = React.memo(({ data }: Props) => {
  return <div>{data}</div>;
});

// ✅ 正确：使用useMemo和useCallback
export function OptimizedComponent({ items }: Props) {
  const expensiveValue = useMemo(() => {
    return items.reduce((sum, item) => sum + item.value, 0);
  }, [items]);

  const handleClick = useCallback((id: string) => {
    // 处理点击
  }, []);

  return <div onClick={handleClick}>{expensiveValue}</div>;
}
```

## 6. 测试规范

### 6.1 单元测试

```typescript
// ✅ 正确：完整的测试用例
describe('UserForm', () => {
  it('应该正确渲染用户表单', () => {
    render(<UserForm userId="123" onSubmit={jest.fn()} />);
    expect(screen.getByLabelText('用户名')).toBeInTheDocument();
  });

  it('应该处理表单提交', async () => {
    const mockSubmit = jest.fn();
    render(<UserForm userId="123" onSubmit={mockSubmit} />);

    fireEvent.click(screen.getByRole('button', { name: '提交' }));
    expect(mockSubmit).toHaveBeenCalled();
  });
});
```

## 7. 文档规范

### 7.1 JSDoc注释

```typescript
/**
 * 获取用户数据
 * @param userId - 用户ID
 * @param options - 请求选项
 * @returns Promise<UserData | null> 用户数据或null
 * @throws {Error} 当请求失败时抛出错误
 */
export async function fetchUserData(
  userId: string,
  options?: RequestOptions
): Promise<UserData | null> {
  // 实现逻辑
}
```

## 8. 禁止事项

### 8.1 严格禁止

- ❌ 使用HTML实体编码（&lt;, &gt;, &amp;等）
- ❌ 使用any类型（除非绝对必要）
- ❌ 忽略错误处理
- ❌ 使用默认导出（除非特殊情况）
- ❌ 硬编码敏感信息

### 8.2 避免使用

- ⚠️ 使用var声明变量
- ⚠️ 使用==比较（应使用===）
- ⚠️ 使用eval()或Function构造函数
- ⚠️ 直接修改props

## 9. 代码审查检查清单

### 9.1 基础检查

- [ ] 代码符合命名规范
- [ ] 类型定义完整
- [ ] 错误处理完善
- [ ] 无console.log残留
- [ ] 无未使用的导入

### 9.2 功能检查

- [ ] 组件props类型正确
- [ ] 事件处理函数类型安全
- [ ] 异步操作有错误处理
- [ ] 状态更新逻辑正确

### 9.3 性能检查

- [ ] 无不必要的重渲染
- [ ] 合理使用useMemo和useCallback
- [ ] 无内存泄漏风险
- [ ] 组件拆分合理

## 10. 工具配置

### 10.1 ESLint规则

```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "error",
    "prefer-const": "error",
    "no-var": "error"
  }
}
```

### 10.2 Prettier配置

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2
}
```

---

**注意**: 本规范是强制性的，所有代码必须严格遵循。违反规范将导致代码审查不通过。
