# 脚本安全规范

## 概述

本文档详细说明了项目中脚本安全的要求和规范，严格禁止脚本修改代码，确保代码安全性和系统稳定性。

## 核心原则

### 1. 代码修改禁令 ⭐⭐⭐
- **禁止脚本修改**: 严格禁止任何脚本自动修改现有代码文件
- **只读操作**: 脚本只能进行读取、分析、检查等只读操作
- **人工确认**: 所有代码修改必须经过人工确认和审查
- **安全优先**: 代码安全性优于自动化便利性

### 2. 脚本操作限制 ⭐⭐⭐
- **只允许检查**: 脚本只能进行代码质量检查、分析、报告
- **禁止写入**: 严格禁止脚本向代码文件写入内容
- **禁止删除**: 严格禁止脚本删除代码文件或内容
- **禁止替换**: 严格禁止脚本替换代码文件内容

## 允许的脚本操作

### 1. 只读检查操作 ✅

#### 代码质量检查
```bash
# ✅ 允许：代码质量检查
npm run type:check
npm run lint
npm run test

# ✅ 允许：代码分析
npm run analyze
npm run coverage
npm run performance

# ✅ 允许：配置检查
npm run config:check
npm run db:check
```

#### 报告生成操作
```bash
# ✅ 允许：生成报告
npm run report:quality
npm run report:coverage
npm run report:performance

# ✅ 允许：生成文档
npm run docs:generate
npm run docs:update
```

#### 环境检查操作
```bash
# ✅ 允许：环境检查
npm run env:check
npm run deps:check
npm run security:check
```

### 2. 脚本安全检查
```bash
# ✅ 允许：脚本安全检查
npm run script:safety
npm run script:check
npm run security:scripts
```

## 严格禁止的脚本操作

### 1. 代码修改操作 ❌

#### 自动修复代码
```bash
# ❌ 禁止：自动修复代码
npm run fix:code
npm run auto-fix
npm run refactor:auto

# ❌ 禁止：自动格式化
npm run format:force
npm run prettier:write
```

#### 文件操作
```bash
# ❌ 禁止：创建代码文件
npm run create:component
npm run generate:code
npm run scaffold:auto

# ❌ 禁止：删除代码文件
npm run clean:code
npm run remove:unused
npm run delete:files
```

#### 配置修改
```bash
# ❌ 禁止：修改配置文件
npm run config:update
npm run env:set
npm run settings:change
```

### 2. 危险操作示例

#### 文件写入操作 ❌
```typescript
// ❌ 禁止：文件写入操作
import { writeFileSync } from 'fs'
writeFileSync('file.ts', 'content') // 严格禁止

// ❌ 禁止：异步文件写入
import { writeFile } from 'fs/promises'
await writeFile('file.ts', 'content') // 严格禁止

// ❌ 禁止：流写入
import { createWriteStream } from 'fs'
const stream = createWriteStream('file.ts') // 严格禁止
```

#### 文件删除操作 ❌
```typescript
// ❌ 禁止：文件删除操作
import { unlinkSync } from 'fs'
unlinkSync('file.ts') // 严格禁止

// ❌ 禁止：目录删除
import { rmdirSync } from 'fs'
rmdirSync('directory') // 严格禁止

// ❌ 禁止：递归删除
import { rmSync } from 'fs'
rmSync('path', { recursive: true }) // 严格禁止
```

#### 文件修改操作 ❌
```typescript
// ❌ 禁止：文件追加操作
import { appendFileSync } from 'fs'
appendFileSync('file.ts', 'content') // 严格禁止

// ❌ 禁止：文件权限修改
import { chmodSync } from 'fs'
chmodSync('file.ts', '755') // 严格禁止

// ❌ 禁止：文件所有者修改
import { chownSync } from 'fs'
chownSync('file.ts', 'user', 'group') // 严格禁止
```

#### 系统命令执行 ❌
```typescript
// ❌ 禁止：系统命令执行
import { execSync } from 'child_process'
execSync('rm -rf files') // 严格禁止

// ❌ 禁止：进程创建
import { spawn } from 'child_process'
spawn('git', ['add', '.']) // 严格禁止
```

## 脚本安全规范

### 1. 脚本权限限制

#### 只读权限
```typescript
// ✅ 允许：只读操作
import { readFileSync, readdirSync, statSync } from 'fs'

// 读取文件内容
const content = readFileSync('file.ts', 'utf-8')

// 读取目录内容
const files = readdirSync('directory')

// 获取文件状态
const stats = statSync('file.ts')
```

#### 无写入权限
```typescript
// ❌ 禁止：任何写入操作
// 所有写入操作都被严格禁止
```

### 2. 脚本内容检查

#### 安全检查函数
```typescript
// ✅ 脚本安全检查
function validateScriptSafety(scriptPath: string): boolean {
  const content = readFileSync(scriptPath, 'utf-8')
  
  // 检查危险操作
  const dangerousOperations = [
    'writeFileSync',
    'writeFile',
    'unlinkSync',
    'unlink',
    'rmdirSync',
    'rmdir',
    'mkdirSync',
    'mkdir',
    'appendFileSync',
    'appendFile',
    'execSync',
    'exec',
    'spawn'
  ]
  
  for (const operation of dangerousOperations) {
    if (content.includes(operation)) {
      throw new Error(`禁止使用 ${operation} 操作`)
    }
  }
  
  return true
}
```

### 3. 脚本验证机制

#### 违规检测
```typescript
// ✅ 检测违规操作
function detectViolations(scriptPath: string): string[] {
  const violations: string[] = []
  const content = readFileSync(scriptPath, 'utf-8')
  
  // 检查文件写入操作
  if (content.includes('writeFile')) {
    violations.push('检测到文件写入操作')
  }
  
  // 检查文件删除操作
  if (content.includes('unlink')) {
    violations.push('检测到文件删除操作')
  }
  
  // 检查文件修改操作
  if (content.includes('appendFile')) {
    violations.push('检测到文件修改操作')
  }
  
  // 检查系统命令执行
  if (content.includes('execSync') || content.includes('spawn')) {
    violations.push('检测到系统命令执行操作')
  }
  
  return violations
}
```

## 脚本监控机制

### 1. 脚本执行监控

#### 执行日志
```typescript
// ✅ 脚本执行日志
interface ScriptExecutionLog {
  scriptName: string
  timestamp: string
  operation: 'read' | 'check' | 'analyze'
  filesAccessed: string[]
  result: 'success' | 'error'
  details: string
}

// ✅ 记录脚本执行
function logScriptExecution(scriptName: string, operation: string) {
  const log: ScriptExecutionLog = {
    scriptName,
    timestamp: new Date().toISOString(),
    operation: 'read',
    filesAccessed: [],
    result: 'success',
    details: 'Script executed safely'
  }
  
  // 记录到日志文件
  console.log(JSON.stringify(log))
}
```

### 2. 实时监控

#### 文件系统监控
```typescript
// ✅ 文件系统监控
import { watch } from 'fs'

function monitorFileSystem() {
  watch('scripts', (eventType, filename) => {
    if (filename && filename.endsWith('.ts')) {
      console.log(`脚本文件 ${filename} 发生变化`)
      // 检查脚本安全性
      checkScriptSafety(`scripts/${filename}`)
    }
  })
}
```

## 脚本开发规范

### 1. 脚本模板

#### 安全脚本模板
```typescript
// ✅ 安全的脚本模板
#!/usr/bin/env tsx

/**
 * 脚本名称 - 只读操作
 * 严格遵循：禁止修改代码文件
 */

import { readFileSync, readdirSync, statSync } from 'fs'
import { join, extname } from 'path'

class SafeScript {
  /**
   * 只读操作：读取文件内容
   */
  private readFile(filePath: string): string {
    try {
      return readFileSync(filePath, 'utf-8')
    } catch (error) {
      console.error(`无法读取文件 ${filePath}:`, error)
      return ''
    }
  }
  
  /**
   * 只读操作：扫描目录
   */
  private scanDirectory(dirPath: string): string[] {
    // 只读操作，不修改任何文件
    const files: string[] = []
    // ... 实现逻辑
    return files
  }
  
  /**
   * 只读操作：生成报告
   */
  public generateReport(): void {
    // 只生成报告，不修改代码
    console.log('生成分析报告...')
  }
}

// 主函数
function main() {
  const script = new SafeScript()
  script.generateReport()
}

if (require.main === module) {
  main()
}
```

### 2. 脚本检查清单

#### 开发前检查
- [ ] 脚本只包含只读操作
- [ ] 没有文件写入操作
- [ ] 没有文件删除操作
- [ ] 没有文件修改操作
- [ ] 没有系统命令执行
- [ ] 只生成报告和分析结果

#### 提交前检查
- [ ] 运行脚本安全检查
- [ ] 确认没有违规操作
- [ ] 验证脚本功能正确
- [ ] 检查脚本文档完整

## 违规处理

### 1. 违规检测

#### 自动检测
```bash
# 运行脚本安全检查
npm run script:safety

# 检查特定脚本
npm run script:check scripts/check-type-safety.ts
```

#### 检测结果
```typescript
// ✅ 违规检测结果
interface ViolationResult {
  script: string
  violations: string[]
  severity: 'high' | 'medium' | 'low'
  recommendations: string[]
}
```

### 2. 违规处理流程

#### 处理步骤
1. **检测违规**: 自动检测脚本中的违规操作
2. **阻止执行**: 立即阻止违规脚本的执行
3. **记录日志**: 记录违规操作到日志文件
4. **通知团队**: 通知开发团队违规情况
5. **修复脚本**: 要求修复违规脚本

#### 严重程度分级
- **高危**: 文件写入、删除、系统命令执行
- **中危**: 文件修改、权限变更
- **低危**: 其他违规操作

## 最佳实践

### 1. 脚本开发原则

#### 安全第一
- **只读优先**: 优先使用只读操作
- **安全第一**: 安全性优于便利性
- **人工确认**: 重要操作需要人工确认
- **文档完整**: 脚本必须有完整的文档

#### 功能限制
- **功能单一**: 每个脚本只负责一个功能
- **职责清晰**: 脚本职责必须清晰明确
- **易于理解**: 脚本代码必须易于理解
- **便于维护**: 脚本必须便于维护

### 2. 脚本使用规范

#### 使用前检查
- **权限确认**: 确认脚本只有只读权限
- **功能验证**: 验证脚本功能符合预期
- **安全扫描**: 运行安全扫描检查
- **文档阅读**: 阅读脚本使用文档

#### 使用后检查
- **结果验证**: 验证脚本执行结果
- **日志检查**: 检查执行日志
- **影响评估**: 评估脚本执行影响
- **问题报告**: 及时报告发现的问题

## 工具和命令

### 1. 脚本安全检查工具

#### 检查命令
```bash
# 检查所有脚本
npm run script:safety

# 检查特定脚本
npm run script:check scripts/check-type-safety.ts

# 安全检查
npm run security:scripts
```

#### 检查内容
- 文件写入操作检测
- 文件删除操作检测
- 文件修改操作检测
- 系统命令执行检测
- 权限变更操作检测

### 2. 监控工具

#### 实时监控
```bash
# 启动脚本监控
npm run monitor:scripts

# 查看监控日志
npm run logs:scripts
```

## 总结

脚本安全规范是项目安全的重要保障：

1. **严格禁止**: 任何脚本都不能修改代码文件
2. **只读操作**: 脚本只能进行读取、分析、检查操作
3. **人工确认**: 所有代码修改必须经过人工确认
4. **安全优先**: 代码安全性是最高优先级
5. **持续监控**: 持续监控脚本安全性

遵循这些规范能够确保代码安全、系统稳定和开发效率。

## 重要提醒

1. **严格禁止**: 任何脚本都不能修改代码文件
2. **只读操作**: 脚本只能进行读取、分析、检查操作
3. **人工确认**: 所有代码修改必须经过人工确认
4. **安全优先**: 代码安全性是最高优先级

**记住**: 脚本只能读取和分析，绝不能修改代码！所有代码修改必须经过人工确认和审查！
