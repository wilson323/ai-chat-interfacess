# éƒ¨ç½²æµç¨‹è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº† NeuroGlass AI Chat Interface é¡¹ç›®çš„éƒ¨ç½²æµç¨‹ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²è§„èŒƒå’Œæœ€ä½³å®è·µã€‚

---

## ğŸŒ ç¯å¢ƒå®šä¹‰

### 1. ç¯å¢ƒåˆ†ç±»

- **å¼€å‘ç¯å¢ƒ (Development)**: æœ¬åœ°å¼€å‘ç¯å¢ƒ
- **æµ‹è¯•ç¯å¢ƒ (Testing)**: åŠŸèƒ½æµ‹è¯•å’Œé›†æˆæµ‹è¯•ç¯å¢ƒ
- **é¢„å‘å¸ƒç¯å¢ƒ (Staging)**: ç”Ÿäº§ç¯å¢ƒé•œåƒï¼Œç”¨äºæœ€ç»ˆéªŒè¯
- **ç”Ÿäº§ç¯å¢ƒ (Production)**: æ­£å¼ç”Ÿäº§ç¯å¢ƒ

### 2. ç¯å¢ƒé…ç½®

#### å¼€å‘ç¯å¢ƒ

```bash
# .env.development
NODE_ENV=development
PORT=3000
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/dev_db
REDIS_URL=redis://localhost:6379
NEXT_TELEMETRY_DISABLED=1
```

#### æµ‹è¯•ç¯å¢ƒ

```bash
# .env.test
NODE_ENV=test
PORT=3001
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db
REDIS_URL=redis://localhost:6379
NEXT_TELEMETRY_DISABLED=1
```

#### ç”Ÿäº§ç¯å¢ƒ

```bash
# .env.production
NODE_ENV=production
PORT=3009
DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/agent_config
REDIS_URL=redis://redis:6379
NEXT_TELEMETRY_DISABLED=1
DOCKER_CONTAINER=true
```

---

## ğŸš€ éƒ¨ç½²ç­–ç•¥

### 1. è“ç»¿éƒ¨ç½² (Blue-Green Deployment)

#### éƒ¨ç½²æµç¨‹

```mermaid
graph TD
    A[å½“å‰ç”Ÿäº§ç¯å¢ƒ Blue] --> B[éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ° Green]
    B --> C[æµ‹è¯•éªŒè¯ Greenç¯å¢ƒ]
    C --> D[åˆ‡æ¢æµé‡åˆ° Green]
    D --> E[ç›‘æ§ Greenç¯å¢ƒ]
    E --> F[ä¿ç•™ Blueç¯å¢ƒå¤‡ç”¨]
```

#### å®æ–½æ­¥éª¤

```yaml
blue_green_deployment:
  preparation:
    - å‡†å¤‡Greenç¯å¢ƒ
    - éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°Green
    - é…ç½®è´Ÿè½½å‡è¡¡å™¨

  testing:
    - å¥åº·æ£€æŸ¥
    - åŠŸèƒ½æµ‹è¯•
    - æ€§èƒ½æµ‹è¯•
    - å®‰å…¨æ‰«æ

  cutover:
    - ä¿®æ”¹DNSæŒ‡å‘
    - æ›´æ–°è´Ÿè½½å‡è¡¡å™¨
    - ç›‘æ§åˆ‡æ¢è¿‡ç¨‹

  cleanup:
    - ä¿ç•™Blueç¯å¢ƒ24å°æ—¶
    - æ¸…ç†æ—§ç‰ˆæœ¬èµ„æº
    - æ›´æ–°æ–‡æ¡£
```

### 2. æ»šåŠ¨éƒ¨ç½² (Rolling Deployment)

#### Kubernetesé…ç½®

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: neuroglass-app
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    spec:
      containers:
        - name: app
          image: neuroglass/app:latest
          ports:
            - containerPort: 3009
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3009
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3009
            initialDelaySeconds: 60
            periodSeconds: 30
```

### 3. é‡‘ä¸é›€éƒ¨ç½² (Canary Deployment)

#### éƒ¨ç½²ç­–ç•¥

```yaml
canary_deployment:
  phases:
    phase1:
      name: '5%æµé‡æµ‹è¯•'
      percentage: 5
      duration: '30åˆ†é’Ÿ'
      metrics:
        - error_rate
        - response_time
        - cpu_usage

    phase2:
      name: '25%æµé‡æµ‹è¯•'
      percentage: 25
      duration: '2å°æ—¶'
      metrics:
        - error_rate
        - response_time
        - business_metrics

    phase3:
      name: '100%æµé‡'
      percentage: 100
      duration: 'æŒç»­'
      metrics:
        - all_metrics
```

---

## ğŸ”§ éƒ¨ç½²å·¥å…·

### 1. Dockeré…ç½®

#### Dockerfile (å¤šé˜¶æ®µæ„å»º)

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM node:18-alpine AS runner
WORKDIR /app

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3009
ENV NEXT_TELEMETRY_DISABLED=1

# æš´éœ²ç«¯å£
EXPOSE 3009

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3009/api/health || exit 1

# å¯åŠ¨åº”ç”¨
USER nextjs
CMD ["node", "server.js"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - '3009:3009'
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - DOCKER_CONTAINER=true
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5452
      - REDIS_URL=redis://redis:6379
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3009/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

  db:
    image: postgres:14-alpine
    container_name: neuroglass-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    ports:
      - '5452:5432'
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: neuroglass-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: neuroglass-nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

### 2. Kubernetesé…ç½®

#### ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: neuroglass-config
data:
  NODE_ENV: 'production'
  PORT: '3009'
  NEXT_TELEMETRY_DISABLED: '1'
```

#### Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: neuroglass-secrets
type: Opaque
data:
  POSTGRES_USER: cm9vdA==
  POSTGRES_PASSWORD: WktUZWNvIyMxMjM=
  JWT_SECRET: eW91ci1qd3Qtc2VjcmV0LWtleQ==
```

---

## ğŸ“‹ éƒ¨ç½²æµç¨‹

### 1. å¼€å‘ç¯å¢ƒéƒ¨ç½²

#### æœ¬åœ°å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
#!/bin/bash
# scripts/setup-dev.sh

echo "ğŸš€ è®¾ç½®å¼€å‘ç¯å¢ƒ..."

# æ£€æŸ¥ä¾èµ–
echo "ğŸ“¦ æ£€æŸ¥Node.jsç‰ˆæœ¬..."
node --version
npm --version

# å®‰è£…ä¾èµ–
echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
npm install

# è®¾ç½®ç¯å¢ƒå˜é‡
echo "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡..."
cp .env.example .env.development

# å¯åŠ¨æ•°æ®åº“
echo "ğŸ—„ï¸ å¯åŠ¨æ•°æ®åº“..."
docker-compose up -d db redis

# è¿è¡Œæ•°æ®åº“è¿ç§»
echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
npm run db:migrate

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
echo "ğŸ–¥ï¸ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
npm run dev
```

### 2. æµ‹è¯•ç¯å¢ƒéƒ¨ç½²

#### è‡ªåŠ¨åŒ–æµ‹è¯•éƒ¨ç½²

```bash
#!/bin/bash
# scripts/deploy-test.sh

set -e

echo "ğŸ§ª éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."

# è¿è¡Œæµ‹è¯•
echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
npm run test:unit

echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
npm run test:integration

echo "ğŸ§ª è¿è¡ŒE2Eæµ‹è¯•..."
npm run test:e2e

# æ„å»ºåº”ç”¨
echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
npm run build

# éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
echo "ğŸ“¤ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨..."
scp -r .next test-server:/opt/neuroglass/
ssh test-server "cd /opt/neuroglass && npm run start"

# è¿è¡Œå¥åº·æ£€æŸ¥
echo "ğŸ¥ è¿è¡Œå¥åº·æ£€æŸ¥..."
curl -f http://test-server:3001/api/health

echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
```

### 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### ç”Ÿäº§éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy-production.sh

set -e

echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."

# é¢„æ£€æŸ¥
echo "ğŸ” è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
./scripts/pre-deploy-check.sh

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
./scripts/backup.sh

# è¿è¡Œæµ‹è¯•
echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
npm run test:ci
npm run test:security
npm run test:performance

# æ„å»ºDockeré•œåƒ
echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
docker build -t neuroglass/app:${VERSION} .

# æ¨é€é•œåƒåˆ°ä»“åº“
echo "ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“..."
docker push neuroglass/app:${VERSION}

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
kubectl set image deployment/neuroglass-app app=neuroglass/app:${VERSION}

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
kubectl rollout status deployment/neuroglass-app --timeout=600s

# è¿è¡Œå¥åº·æ£€æŸ¥
echo "ğŸ¥ è¿è¡Œå¥åº·æ£€æŸ¥..."
./scripts/health-check.sh

# éªŒè¯éƒ¨ç½²
echo "âœ… éªŒè¯éƒ¨ç½²..."
./scripts/verify-deployment.sh

echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ” éƒ¨ç½²å‰æ£€æŸ¥

### 1. ä»£ç è´¨é‡æ£€æŸ¥

```bash
#!/bin/bash
# scripts/pre-deploy-check.sh

echo "ğŸ” è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."

# ä»£ç è´¨é‡æ£€æŸ¥
echo "ğŸ“Š æ£€æŸ¥ä»£ç è´¨é‡..."
npm run check-code
if [ $? -ne 0 ]; then
    echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
    exit 1
fi

# è‡ªå®šä¹‰ä»£ç å æ¯”æ£€æŸ¥
echo "ğŸ“Š æ£€æŸ¥è‡ªå®šä¹‰ä»£ç å æ¯”..."
npm run check:custom-ratio
if [ $? -ne 0 ]; then
    echo "âŒ è‡ªå®šä¹‰ä»£ç å æ¯”è¿‡é«˜"
    exit 1
fi

# å®‰å…¨æ£€æŸ¥
echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
npm run test:security
if [ $? -ne 0 ]; then
    echo "âŒ å®‰å…¨æ£€æŸ¥å¤±è´¥"
    exit 1
fi

# æ€§èƒ½æ£€æŸ¥
echo "âš¡ è¿è¡Œæ€§èƒ½æ£€æŸ¥..."
npm run test:performance
if [ $? -ne 0 ]; then
    echo "âŒ æ€§èƒ½æ£€æŸ¥å¤±è´¥"
    exit 1
fi

echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
```

### 2. ç¯å¢ƒé…ç½®æ£€æŸ¥

```bash
#!/bin/bash
# scripts/check-environment.sh

echo "ğŸ” æ£€æŸ¥ç¯å¢ƒé…ç½®..."

# æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
required_vars=(
    "NODE_ENV"
    "PORT"
    "DATABASE_URL"
    "REDIS_URL"
    "JWT_SECRET"
    "FASTGPT_API_KEY"
    "OPENAI_AUDIO_API_KEY"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "âŒ ç¯å¢ƒå˜é‡ $var æœªè®¾ç½®"
        exit 1
    fi
done

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
npm run check-db

# æ£€æŸ¥Redisè¿æ¥
echo "ğŸ”´ æ£€æŸ¥Redisè¿æ¥..."
npm run check-redis

echo "âœ… ç¯å¢ƒé…ç½®æ£€æŸ¥é€šè¿‡ï¼"
```

---

## ğŸ¥ å¥åº·æ£€æŸ¥

### 1. åº”ç”¨å¥åº·æ£€æŸ¥

```typescript
// app/api/health/route.ts
import { NextResponse } from 'next/server';
import { sequelize } from '@/lib/db/sequelize';
import { redisClient } from '@/lib/redis';

export async function GET() {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    version: process.env.npm_package_version || 'unknown',
    uptime: process.uptime(),
    checks: {
      database: await checkDatabase(),
      redis: await checkRedis(),
      externalApis: await checkExternalApis(),
    },
  };

  const isHealthy = Object.values(health.checks).every(
    check => check.status === 'healthy'
  );

  return NextResponse.json(health, {
    status: isHealthy ? 200 : 503,
  });
}

async function checkDatabase() {
  try {
    await sequelize.authenticate();
    await sequelize.query('SELECT 1');
    return { status: 'healthy', latency: Date.now() };
  } catch (error) {
    return {
      status: 'unhealthy',
      error: error.message,
      latency: Date.now(),
    };
  }
}

async function checkRedis() {
  try {
    await redisClient.ping();
    return { status: 'healthy', latency: Date.now() };
  } catch (error) {
    return {
      status: 'unhealthy',
      error: error.message,
      latency: Date.now(),
    };
  }
}

async function checkExternalApis() {
  const checks = {};

  // æ£€æŸ¥FastGPT API
  try {
    const response = await fetch(process.env.FASTGPT_API_URL, {
      headers: {
        Authorization: `Bearer ${process.env.FASTGPT_API_KEY}`,
      },
    });
    checks.fastgpt = response.ok ? 'healthy' : 'unhealthy';
  } catch (error) {
    checks.fastgpt = 'unhealthy';
  }

  return checks;
}
```

### 2. ç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# scripts/health-check.sh

echo "ğŸ¥ è¿è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥..."

# æ£€æŸ¥åº”ç”¨æœåŠ¡
echo "ğŸŒ æ£€æŸ¥åº”ç”¨æœåŠ¡..."
APP_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3009/api/health)
if [ "$APP_HEALTH" -eq 200 ]; then
    echo "âœ… åº”ç”¨æœåŠ¡æ­£å¸¸"
else
    echo "âŒ åº”ç”¨æœåŠ¡å¼‚å¸¸ (HTTP $APP_HEALTH)"
    exit 1
fi

# æ£€æŸ¥æ•°æ®åº“
echo "ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“..."
DB_HEALTH=$(docker exec neuroglass-postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB})
if [ $? -eq 0 ]; then
    echo "âœ… æ•°æ®åº“æ­£å¸¸"
else
    echo "âŒ æ•°æ®åº“å¼‚å¸¸"
    exit 1
fi

# æ£€æŸ¥Redis
echo "ğŸ”´ æ£€æŸ¥Redis..."
REDIS_HEALTH=$(docker exec neuroglass-redis redis-cli ping)
if [ "$REDIS_HEALTH" = "PONG" ]; then
    echo "âœ… Redisæ­£å¸¸"
else
    echo "âŒ Rediså¼‚å¸¸"
    exit 1
fi

# æ£€æŸ¥èµ„æºä½¿ç”¨
echo "ğŸ“Š æ£€æŸ¥èµ„æºä½¿ç”¨..."
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
MEMORY_USAGE=$(free | grep Mem | awk '{print ($3/$2) * 100.0}')

echo "CPUä½¿ç”¨ç‡: ${CPU_USAGE}%"
echo "å†…å­˜ä½¿ç”¨ç‡: ${MEMORY_USAGE}%"

if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "âš ï¸ CPUä½¿ç”¨ç‡è¿‡é«˜"
fi

if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
    echo "âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
fi

echo "âœ… ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆï¼"
```

---

## ğŸ”„ å›æ»šæµç¨‹

### 1. å¿«é€Ÿå›æ»š

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

VERSION=${1:-"previous"}

echo "ğŸ”„ å¼€å§‹å›æ»šåˆ°ç‰ˆæœ¬ $VERSION..."

# æ£€æŸ¥å½“å‰çŠ¶æ€
echo "ğŸ” æ£€æŸ¥å½“å‰éƒ¨ç½²çŠ¶æ€..."
kubectl get deployment neuroglass-app

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
echo "ğŸ”„ å›æ»šéƒ¨ç½²..."
kubectl rollout undo deployment/neuroglass-app --to-revision=$VERSION

# ç­‰å¾…å›æ»šå®Œæˆ
echo "â³ ç­‰å¾…å›æ»šå®Œæˆ..."
kubectl rollout status deployment/neuroglass-app --timeout=600s

# éªŒè¯å›æ»š
echo "âœ… éªŒè¯å›æ»šç»“æœ..."
./scripts/verify-deployment.sh

echo "ğŸ‰ å›æ»šå®Œæˆï¼"
```

### 2. æ•°æ®åº“å›æ»š

```bash
#!/bin/bash
# scripts/rollback-database.sh

set -e

echo "ğŸ”„ å¼€å§‹æ•°æ®åº“å›æ»š..."

# å¤‡ä»½å½“å‰æ•°æ®åº“
echo "ğŸ’¾ å¤‡ä»½å½“å‰æ•°æ®åº“..."
./scripts/backup-db.sh

# æ‰§è¡Œå›æ»š
echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“å›æ»š..."
npm run db:rollback

# éªŒè¯æ•°æ®å®Œæ•´æ€§
echo "âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§..."
./scripts/verify-data.sh

echo "ğŸ‰ æ•°æ®åº“å›æ»šå®Œæˆï¼"
```

---

## ğŸ“Š éƒ¨ç½²ç›‘æ§

### 1. éƒ¨ç½²æŒ‡æ ‡ç›‘æ§

```typescript
// lib/monitoring/deployment-metrics.ts
export class DeploymentMetrics {
  private metrics = new Map<string, any>();

  recordDeployment(deployment: {
    version: string;
    environment: string;
    startTime: Date;
    endTime?: Date;
    status: 'success' | 'failed' | 'rolling-back';
    duration?: number;
    error?: string;
  }) {
    const key = `${deployment.environment}_${deployment.version}`;
    this.metrics.set(key, deployment);
  }

  getDeploymentHistory(environment: string, limit = 10) {
    return Array.from(this.metrics.values())
      .filter(d => d.environment === environment)
      .sort((a, b) => b.startTime.getTime() - a.startTime.getTime())
      .slice(0, limit);
  }

  getSuccessRate(environment: string) {
    const deployments = this.getDeploymentHistory(environment, 50);
    const successful = deployments.filter(d => d.status === 'success').length;
    return (successful / deployments.length) * 100;
  }

  getAverageDeploymentTime(environment: string) {
    const deployments = this.getDeploymentHistory(environment, 50).filter(
      d => d.status === 'success' && d.duration
    );

    if (deployments.length === 0) return 0;

    const totalTime = deployments.reduce((sum, d) => sum + d.duration!, 0);
    return totalTime / deployments.length;
  }
}
```

### 2. éƒ¨ç½²é€šçŸ¥

```typescript
// lib/notifications/deployment-notifier.ts
export class DeploymentNotifier {
  async notifySuccess(deployment: DeploymentInfo) {
    const message = `
ğŸ‰ éƒ¨ç½²æˆåŠŸï¼

ç¯å¢ƒ: ${deployment.environment}
ç‰ˆæœ¬: ${deployment.version}
æŒç»­æ—¶é—´: ${deployment.duration}ms
éƒ¨ç½²æ—¶é—´: ${deployment.timestamp}

âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡
    `;

    await this.sendNotification('success', message);
  }

  async notifyFailure(deployment: DeploymentInfo, error: string) {
    const message = `
âŒ éƒ¨ç½²å¤±è´¥ï¼

ç¯å¢ƒ: ${deployment.environment}
ç‰ˆæœ¬: ${deployment.version}
é”™è¯¯: ${error}
éƒ¨ç½²æ—¶é—´: ${deployment.timestamp}

ğŸ”„ æ­£åœ¨å¯åŠ¨å›æ»šæµç¨‹...
    `;

    await this.sendNotification('failure', message);
  }

  private async sendNotification(type: 'success' | 'failure', message: string) {
    // Slacké€šçŸ¥
    await this.sendSlackNotification(message);

    // é‚®ä»¶é€šçŸ¥
    await this.sendEmailNotification(message);

    // PagerDutyé€šçŸ¥ (ä»…é™failure)
    if (type === 'failure') {
      await this.sendPagerDutyNotification(message);
    }
  }
}
```

---

## ğŸ“‹ éƒ¨ç½²æ–‡æ¡£

### 1. éƒ¨ç½²æ£€æŸ¥æ¸…å•

```markdown
## éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] ç¯å¢ƒé…ç½®éªŒè¯
- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡

## éƒ¨ç½²è¿‡ç¨‹æ£€æŸ¥æ¸…å•

- [ ] éƒ¨ç½²è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] æœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] é…ç½®æ–‡ä»¶æ­£ç¡®
- [ ] æƒé™è®¾ç½®æ­£ç¡®

## éƒ¨ç½²åæ£€æŸ¥æ¸…å•

- [ ] åº”ç”¨åŠŸèƒ½æ­£å¸¸
- [ ] æ€§èƒ½æŒ‡æ ‡æ­£å¸¸
- [ ] é”™è¯¯æ—¥å¿—æ­£å¸¸
- [ ] ç›‘æ§æ•°æ®æ­£å¸¸
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] æ–‡æ¡£æ›´æ–°
```

### 2. æ•…éšœæ¢å¤æµç¨‹

```markdown
## æ•…éšœåˆ†ç±»

1. **P1 - ä¸¥é‡æ•…éšœ**: æœåŠ¡å®Œå…¨ä¸å¯ç”¨
2. **P2 - é‡è¦æ•…éšœ**: æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
3. **P3 - ä¸€èˆ¬æ•…éšœ**: éæ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸

## æ•…éšœå“åº”æ—¶é—´

- **P1**: 15åˆ†é’Ÿå†…å“åº”
- **P2**: 30åˆ†é’Ÿå†…å“åº”
- **P3**: 2å°æ—¶å†…å“åº”

## æ•…éšœæ¢å¤æ­¥éª¤

1. ç«‹å³é€šçŸ¥ç›¸å…³äººå‘˜
2. å¯åŠ¨æ•…éšœè¯Šæ–­
3. æ‰§è¡Œä¸´æ—¶ä¿®å¤
4. å¯åŠ¨å›æ»šæµç¨‹ï¼ˆå¦‚éœ€è¦ï¼‰
5. æ ¹å› åˆ†æ
6. å®æ–½æ°¸ä¹…ä¿®å¤
7. éªŒè¯ä¿®å¤æ•ˆæœ
```

---

**æœ€åæ›´æ–°**: 2025-01-13
**ç‰ˆæœ¬**: v1.0.0
**ç»´æŠ¤è€…**: è¿ç»´å›¢é˜Ÿ
