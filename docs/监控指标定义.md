# 监控指标定义

## 📊 概述

本文档定义了 NeuroGlass AI Chat Interface 项目的监控指标体系，包括应用性能、业务指标、系统资源等各个维度的监控指标定义和告警规则。

---

## 🎯 监控指标分类

### 1. 应用性能指标 (APM)
### 2. 业务指标
### 3. 系统资源指标
### 4. 数据库指标
### 5. 网络指标
### 6. 安全指标

---

## 📈 应用性能指标

### 1. 响应时间指标

#### HTTP响应时间
```typescript
interface HttpResponseTimeMetrics {
  // P50 响应时间
  p50_response_time: number;    // 目标: < 200ms

  // P95 响应时间
  p95_response_time: number;    // 目标: < 500ms

  // P99 响应时间
  p99_response_time: number;    // 目标: < 1000ms

  // 平均响应时间
  avg_response_time: number;    // 目标: < 300ms

  // 最大响应时间
  max_response_time: number;    // 目标: < 2000ms
}
```

#### API端点响应时间
```typescript
interface ApiEndpointMetrics {
  // 聊天API响应时间
  chat_api_response_time: number;    // 目标: < 1000ms

  // 认证API响应时间
  auth_api_response_time: number;    // 目标: < 200ms

  // 文件上传API响应时间
  upload_api_response_time: number;  // 目标: < 5000ms

  // 语音识别API响应时间
  voice_api_response_time: number;   // 目标: < 3000ms

  // CAD分析API响应时间
  cad_api_response_time: number;     // 目标: < 10000ms
}
```

### 2. 吞吐量指标

```typescript
interface ThroughputMetrics {
  // 每秒请求数
  requests_per_second: number;       // 目标: > 100 RPS

  // 每秒消息数
  messages_per_second: number;       // 目标: > 50 MPS

  // 并发用户数
  concurrent_users: number;          // 目标: > 1000

  // 每分钟文件上传数
  uploads_per_minute: number;       // 目标: > 10

  // 每分钟语音请求数
  voice_requests_per_minute: number; // 目标: > 5
}
```

### 3. 错误率指标

```typescript
interface ErrorRateMetrics {
  // HTTP 5xx 错误率
  http_5xx_error_rate: number;       // 目标: < 0.1%

  // HTTP 4xx 错误率
  http_4xx_error_rate: number;       // 目标: < 1%

  // 总错误率
  total_error_rate: number;         // 目标: < 0.5%

  // API超时率
  timeout_rate: number;             // 目标: < 0.05%

  // 业务逻辑错误率
  business_error_rate: number;      // 目标: < 0.2%
}
```

---

## 💼 业务指标

### 1. 用户活跃度指标

```typescript
interface UserActivityMetrics {
  // 日活跃用户数
  daily_active_users: number;       // 目标: > 100

  // 月活跃用户数
  monthly_active_users: number;     // 目标: > 1000

  // 新用户注册数
  new_users_per_day: number;        // 目标: > 10

  // 用户留存率
  user_retention_rate: number;      // 目标: > 80%

  // 平均会话时长
  avg_session_duration: number;      // 目标: > 300秒
}
```

### 2. 智能体使用指标

```typescript
interface AgentUsageMetrics {
  // FastGPT智能体调用次数
  fastgpt_calls_count: number;       // 目标: 持续增长

  // CAD分析器使用次数
  cad_analyzer_usage: number;       // 目标: > 10/天

  // 图像编辑器使用次数
  image_editor_usage: number;       // 目标: > 5/天

  // 智能体切换频率
  agent_switch_frequency: number;   // 目标: < 5次/会话

  // 平均对话轮次
  avg_conversation_rounds: number;  // 目标: > 3轮
}
```

### 3. 用户体验指标

```typescript
interface UserExperienceMetrics {
  // 用户满意度评分
  user_satisfaction_score: number;   // 目标: > 4.5/5

  // 功能使用率
  feature_usage_rate: number;      // 目标: > 70%

  // 页面加载时间
  page_load_time: number;          // 目标: < 3秒

  // 交互响应时间
  interaction_response_time: number; // 目标: < 100ms

  // 用户投诉数量
  user_complaints_count: number;    // 目标: < 1/天
}
```

---

## 🔧 系统资源指标

### 1. CPU指标

```typescript
interface CpuMetrics {
  // CPU使用率
  cpu_usage_percent: number;        // 目标: < 80%

  // CPU负载均衡
  cpu_load_average: number;         // 目标: < 核心数

  // CPU iowait
  cpu_iowait_percent: number;       // 目标: < 5%

  // CPUsteal时间
  cpu_steal_percent: number;        // 目标: < 1%

  // 进程CPU使用率
  process_cpu_percent: number;      // 目标: < 50%
}
```

### 2. 内存指标

```typescript
interface MemoryMetrics {
  // 内存使用率
  memory_usage_percent: number;     // 目标: < 80%

  // 可用内存
  available_memory_mb: number;      // 目标: > 1GB

  // 交换分区使用
  swap_usage_percent: number;       // 目标: < 10%

  // 内存缓存命中率
  cache_hit_rate: number;           // 目标: > 90%

  // 进程内存使用
  process_memory_mb: number;        // 目标: < 1GB
}
```

### 3. 磁盘指标

```typescript
interface DiskMetrics {
  // 磁盘使用率
  disk_usage_percent: number;       // 目标: < 80%

  // 磁盘可用空间
  available_disk_gb: number;        // 目标: > 10GB

  // 磁盘IOPS
  disk_iops: number;                // 目标: > 1000

  // 磁盘吞吐量
  disk_throughput_mb_s: number;     // 目标: > 100MB/s

  // 磁盘延迟
  disk_latency_ms: number;          // 目标: < 10ms
}
```

---

## 🗄️ 数据库指标

### 1. PostgreSQL指标

```typescript
interface PostgresMetrics {
  // 数据库连接数
  active_connections: number;       // 目标: < max_connections * 80%

  // 查询响应时间
  query_response_time_ms: number;   // 目标: < 100ms

  // 慢查询数量
  slow_query_count: number;         // 目标: < 5/分钟

  // 缓存命中率
  cache_hit_ratio: number;          // 目标: > 95%

  // 事务处理时间
  transaction_time_ms: number;      // 目标: < 50ms

  // 索引使用率
  index_usage_ratio: number;        // 目标: > 90%
}
```

### 2. 连接池指标

```typescript
interface ConnectionPoolMetrics {
  // 活跃连接数
  active_connections: number;       // 目标: < max_pool_size * 80%

  // 空闲连接数
  idle_connections: number;         // 目标: > min_pool_size

  // 等待连接数
  waiting_connections: number;     // 目标: 0

  // 连接获取时间
  connection_acquire_time_ms: number; // 目标: < 10ms

  // 连接泄漏数
  connection_leaks: number;         // 目标: 0
}
```

---

## 🌐 网络指标

### 1. 网络流量指标

```typescript
interface NetworkMetrics {
  // 入站流量
  inbound_traffic_mb_s: number;     // 目标: < 100MB/s

  // 出站流量
  outbound_traffic_mb_s: number;    // 目标: < 100MB/s

  // 网络延迟
  network_latency_ms: number;       // 目标: < 50ms

  // 网络丢包率
  packet_loss_percent: number;      // 目标: < 0.1%

  // TCP连接数
  tcp_connections: number;          // 目标: < 10000
}
```

### 2. 负载均衡指标

```typescript
interface LoadBalancerMetrics {
  // 后端服务器健康状态
  backend_health_status: boolean;   // 目标: true

  // 请求分发率
  request_distribution_rate: number; // 目标: 均匀分布

  // 会话保持成功率
  session_stickiness_rate: number;  // 目标: > 99%

  // 负载均衡响应时间
  lb_response_time_ms: number;       // 目标: < 5ms
}
```

---

## 🔒 安全指标

### 1. 认证授权指标

```typescript
interface AuthSecurityMetrics {
  // 认证失败次数
  auth_failures_count: number;       // 目标: < 10/小时

  // 授权拒绝次数
  authorization_denials: number;    // 目标: < 5/小时

  // JWT token验证失败
  jwt_validation_failures: number;  // 目标: < 1/小时

  // 异常登录尝试
  suspicious_logins: number;        // 目标: < 3/小时

  // 密码重置请求
  password_reset_requests: number;  // 目标: < 5/天
}
```

### 2. 输入验证指标

```typescript
interface InputValidationMetrics {
  // 输入验证失败次数
  validation_failures: number;      // 目标: < 100/小时

  // SQL注入尝试
  sql_injection_attempts: number;   // 目标: 0

  // XSS攻击尝试
  xss_attempts: number;             // 目标: 0

  // 文件上传验证失败
  upload_validation_failures: number; // 目标: < 10/小时

  // API参数验证失败
  api_validation_failures: number;  // 目标: < 50/小时
}
```

### 3. 访问控制指标

```typescript
interface AccessControlMetrics {
  // 越权访问尝试
  unauthorized_access_attempts: number; // 目标: 0

  // 权限检查失败
  permission_check_failures: number;    // 目标: < 5/小时

  // 角色分配异常
  role_assignment_anomalies: number;     // 目标: < 1/天

  // 敏感操作未授权
  sensitive_unauthorized_ops: number;    // 目标: 0

  // API密钥异常使用
  api_key_misuse: number;               // 目标: 0
}
```

---

## 🚨 告警规则定义

### 1. 关键告警 (Critical)

#### P1级别告警
```yaml
critical_alerts:
  - name: "服务不可用"
    condition: "up == 0"
    for: "1m"
    labels:
      severity: "critical"
      priority: "P1"
    annotations:
      summary: "应用服务不可用"
      description: "应用服务在{{ $labels.instance }}上不可用"
      runbook_url: "https://wiki.company.com/runbooks/service-down"

  - name: "数据库不可用"
    condition: "pg_up == 0"
    for: "1m"
    labels:
      severity: "critical"
      priority: "P1"
    annotations:
      summary: "数据库连接失败"
      description: "无法连接到数据库{{ $labels.instance }}"

  - name: "高错误率"
    condition: "rate(http_requests_total{status=~\"5..\"}[5m]) > 0.1"
    for: "5m"
    labels:
      severity: "critical"
      priority: "P1"
    annotations:
      summary: "HTTP 5xx错误率过高"
      description: "5分钟内5xx错误率超过10%"
```

### 2. 重要告警 (High)

#### P2级别告警
```yaml
high_alerts:
  - name: "高响应时间"
    condition: "histogram_quantile(0.95, http_request_duration_seconds_bucket) > 1"
    for: "5m"
    labels:
      severity: "high"
      priority: "P2"
    annotations:
      summary: "95%响应时间超过1秒"
      description: "95%的请求响应时间超过1秒"

  - name: "高内存使用"
    condition: "process_resident_memory_bytes / 1024 / 1024 / 1024 > 1"
    for: "10m"
    labels:
      severity: "high"
      priority: "P2"
    annotations:
      summary: "内存使用超过1GB"
      description: "应用内存使用量超过1GB"

  - name: "数据库连接池耗尽"
    condition: "pg_stat_database_numbackends / pg_settings_max_connections > 0.8"
    for: "5m"
    labels:
      severity: "high"
      priority: "P2"
    annotations:
      summary: "数据库连接池使用率超过80%"
      description: "数据库连接池使用率过高，可能存在连接泄漏"
```

### 3. 警告告警 (Warning)

#### P3级别告警
```yaml
warning_alerts:
  - name: "CPU使用率过高"
    condition: "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100) > 80"
    for: "10m"
    labels:
      severity: "warning"
      priority: "P3"
    annotations:
      summary: "CPU使用率超过80%"
      description: "{{ $labels.instance }}的CPU使用率超过80%"

  - name: "磁盘空间不足"
    condition: "100 - ((node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100) < 20"
    for: "5m"
    labels:
      severity: "warning"
      priority: "P3"
    annotations:
      summary: "磁盘空间不足20%"
      description: "{{ $labels.instance }}的{{ $labels.mountpoint }}磁盘空间不足20%"

  - name: "4xx错误率上升"
    condition: "rate(http_requests_total{status=~\"4..\"}[5m]) / rate(http_requests_total[5m]) > 0.05"
    for: "5m"
    labels:
      severity: "warning"
      priority: "P3"
    annotations:
      summary: "4xx错误率超过5%"
      description: "客户端错误率超过5%，可能存在客户端配置问题"
```

---

## 📊 指标收集和存储

### 1. 指标收集频率

```typescript
interface MetricCollectionFrequency {
  // 实时指标 (秒级)
  real_time_metrics: number;        // 10秒间隔

  // 性能指标 (分钟级)
  performance_metrics: number;      // 1分钟间隔

  // 业务指标 (小时级)
  business_metrics: number;         // 1小时间隔

  // 系统指标 (分钟级)
  system_metrics: number;          // 1分钟间隔

  // 累计指标 (天级)
  aggregated_metrics: number;       // 1天间隔
}
```

### 2. 指标存储策略

```typescript
interface MetricStoragePolicy {
  // 短期存储 (实时监控)
  short_term_retention: number;     // 7天

  // 中期存储 (趋势分析)
  medium_term_retention: number;    // 30天

  // 长期存储 (历史分析)
  long_term_retention: number;      // 365天

  // 聚合精度
  aggregation_resolution: string;    // 1分钟, 5分钟, 1小时, 1天

  // 压缩策略
  compression_enabled: boolean;     // true
}
```

---

## 🎯 监控仪表板

### 1. 系统概览仪表板
- **系统健康状态**: 整体系统可用性
- **关键指标**: 响应时间、错误率、吞吐量
- **资源使用**: CPU、内存、磁盘、网络
- **业务指标**: 用户活跃度、功能使用率

### 2. 应用性能仪表板
- **响应时间分布**: P50, P95, P99响应时间
- **吞吐量趋势**: RPS、MPS、并发用户数
- **错误率分析**: 按错误类型和端点分类
- **API性能**: 各API端点的性能指标

### 3. 数据库监控仪表板
- **连接状态**: 连接数、连接池状态
- **查询性能**: 慢查询、查询响应时间
- **资源使用**: CPU、内存、磁盘I/O
- **缓存效果**: 缓存命中率、索引使用率

### 4. 业务监控仪表板
- **用户行为**: 活跃用户、留存率、会话时长
- **功能使用**: 智能体使用、功能使用率
- **用户反馈**: 满意度评分、投诉数量
- **业务趋势**: 增长趋势、使用模式

---

## 🔧 监控工具配置

### 1. Prometheus配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'neuroglass-app'
    static_configs:
      - targets: ['localhost:3009']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'postgres'
    static_configs:
      - targets: ['localhost:9187']
    scrape_interval: 30s

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
    scrape_interval: 30s
```

### 2. Grafana仪表板配置
```json
{
  "dashboard": {
    "title": "NeuroGlass监控概览",
    "panels": [
      {
        "title": "系统可用性",
        "type": "stat",
        "targets": [
          {
            "expr": "up",
            "legendFormat": "可用性"
          }
        ]
      },
      {
        "title": "响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, http_request_duration_seconds_bucket)",
            "legendFormat": "P95响应时间"
          }
        ]
      }
    ]
  }
}
```

---

## 📈 告警通知渠道

### 1. 邮件通知
- **接收人**: 开发团队、运维团队
- **严重程度**: Critical, High
- **发送频率**: 立即发送

### 2. Slack通知
- **频道**: #alerts, #devops-alerts
- **严重程度**: Critical, High, Warning
- **发送频率**: 立即发送

### 3. 短信通知
- **接收人**: 值班人员、技术负责人
- **严重程度**: Critical only
- **发送频率**: 立即发送

### 4. PagerDuty
- **服务**: NeuroGlass生产环境
- **严重程度**: Critical, High
- **发送频率**: 立即发送

---

## 🔄 指标维护和优化

### 1. 定期审查
- **月度审查**: 指标有效性、告警规则调整
- **季度审查**: 监控策略优化、工具升级
- **年度审查**: 监控体系重构、架构优化

### 2. 性能优化
- **指标收集优化**: 减少不必要指标收集
- **存储优化**: 合理设置保留策略
- **查询优化**: 优化Prometheus查询性能
- **可视化优化**: 改进仪表板响应速度

---

**最后更新**: 2025-01-13
**版本**: v1.0.0
**维护者**: 运维团队