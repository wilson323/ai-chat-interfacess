# 环境配置管理规范

## 🎯 配置管理原则

### 1. 统一配置源
- **环境变量优先**: 所有配置优先从环境变量读取
- **配置文件备用**: 环境变量不存在时从配置文件读取
- **默认值兜底**: 提供合理的默认值确保系统正常运行

### 2. 配置分类管理
- **敏感配置**: 数据库密码、API密钥等必须通过环境变量管理
- **环境特定配置**: 不同环境的配置通过环境变量区分
- **功能开关**: 通过环境变量控制功能启用/禁用

## 📋 环境变量清单

### 必需环境变量
```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ai_chat
DB_USER=postgres
DB_PASSWORD=your_password_here

# 安全配置
JWT_SECRET=your_jwt_secret_key_here

# API配置
API_BASE_URL=http://localhost:3000
```

### 可选环境变量
```bash
# 功能开关
ENABLE_VOICE=true
ENABLE_FILE_UPLOAD=true
ENABLE_IMAGE_UPLOAD=true
ENABLE_STREAMING=true

# 文件上传配置
MAX_FILE_SIZE=10485760
ALLOWED_FILE_TYPES=jpg,jpeg,png,gif,pdf,doc,docx,txt,md

# AI模型配置
QWEN_API_KEY=your_qwen_api_key_here
GLM_API_KEY=your_glm_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
```

## 🔧 配置实现方案

### 1. 环境变量验证
```typescript
// lib/config/validation.ts
export function validateRequiredEnvVars(): void {
  const requiredVars = [
    'DB_HOST',
    'DB_NAME', 
    'DB_USER',
    'DB_PASSWORD',
    'JWT_SECRET'
  ]

  const missing = requiredVars.filter(varName => !process.env[varName])
  
  if (missing.length > 0) {
    throw new Error(`Missing required environment variables: ${missing.join(', ')}`)
  }
}
```

### 2. 配置类型安全
```typescript
// types/config.ts
export interface DatabaseConfig {
  host: string
  port: number
  database: string
  username: string
  password: string
  ssl: boolean
  pool: {
    max: number
    min: number
    acquire: number
    idle: number
  }
}

export interface AppConfig {
  database: DatabaseConfig
  api: ApiConfig
  features: FeatureConfig
  security: SecurityConfig
}
```

### 3. 配置获取工具
```typescript
// lib/config/utils.ts
export function getEnvVar<T = string>(
  key: string, 
  defaultValue?: T,
  transform?: (value: string) => T
): T {
  const value = process.env[key]
  
  if (value === undefined) {
    if (defaultValue !== undefined) {
      return defaultValue
    }
    throw new Error(`Environment variable ${key} is required`)
  }
  
  return transform ? transform(value) : (value as T)
}

export function getBooleanEnvVar(key: string, defaultValue = false): boolean {
  return getEnvVar(key, defaultValue, (value) => 
    value.toLowerCase() === 'true'
  )
}

export function getNumberEnvVar(key: string, defaultValue?: number): number {
  return getEnvVar(key, defaultValue, (value) => parseInt(value, 10))
}
```

## 📁 配置文件结构

### 环境变量文件
```
.env.local          # 本地开发环境（不提交到Git）
.env.development    # 开发环境配置
.env.test          # 测试环境配置  
.env.production    # 生产环境配置
.env.example       # 配置模板文件（提交到Git）
```

### 配置文件迁移
```typescript
// 从 config/config.json 迁移到环境变量
// 旧配置方式
const dbConfig = require('./config/config.json')[NODE_ENV]

// 新配置方式
const dbConfig = {
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_NAME || 'ai_chat',
  username: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD || '',
  ssl: process.env.DB_SSL === 'true'
}
```

## 🛠️ 配置管理最佳实践

### 1. 配置验证
- 启动时验证必需的环境变量
- 提供清晰的错误信息指导配置
- 支持配置热重载（开发环境）

### 2. 配置安全
- 敏感信息不能出现在代码中
- 使用.env文件管理本地配置
- 生产环境使用环境变量或密钥管理服务

### 3. 配置文档
- 维护完整的环境变量文档
- 提供配置示例和说明
- 定期更新配置变更记录

## ⚠️ 重要提醒

1. **安全第一**: 敏感配置必须通过环境变量管理
2. **环境隔离**: 不同环境使用不同的配置文件
3. **默认值**: 提供合理的默认值确保系统可用
4. **文档同步**: 配置变更必须同步更新文档
5. **验证机制**: 启动时验证配置完整性

**记住: 好的配置管理是系统稳定运行的基础！**

