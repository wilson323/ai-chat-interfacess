# 代码开发规范与流程文档

## 概述

本文档定义了项目的代码开发规范、命名约定、文件结构、注释规范等，旨在确保代码质量、可维护性和团队协作效率。

## 1. 命名规范

### 1.1 变量和函数命名

- **风格**: camelCase
- **示例**: `userName`, `getUserData`, `isAuthenticated`
- **规则**:
  - 变量名应具有描述性
  - 布尔变量使用 `is`、`has`、`can` 等前缀
  - 函数名应使用动词开头

### 1.2 类和接口命名

- **风格**: PascalCase
- **示例**: `UserService`, `ApiResponse`, `DatabaseConnection`
- **规则**:
  - 类名使用名词
  - 接口名使用名词，可以添加 `I` 前缀（可选）
  - 抽象类使用 `Abstract` 前缀

### 1.3 常量和枚举命名

- **风格**: UPPER_SNAKE_CASE
- **示例**: `API_BASE_URL`, `MAX_RETRY_COUNT`, `LogLevel`
- **规则**:
  - 常量使用全大写
  - 枚举值使用全大写

### 1.4 文件命名

- **风格**: kebab-case
- **示例**: `user-service.ts`, `api-client.ts`, `error-handler.ts`
- **规则**:
  - 文件名应描述其功能
  - 组件文件使用 PascalCase (React组件)

## 2. TypeScript 规范

### 2.1 类型定义

```typescript
// ✅ 推荐：明确的类型定义
interface User {
  id: number;
  name: string;
  email: string;
  createdAt: Date;
}

// ✅ 推荐：使用泛型
interface ApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
}

// ❌ 避免：使用 any
function processData(data: any): any {
  // ...
}

// ✅ 推荐：使用具体类型或 unknown
function processData(data: unknown): ProcessedData {
  // ...
}
```

### 2.2 严格模式配置

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "noImplicitReturns": true,
    "noImplicitThis": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    "noUncheckedIndexedAccess": true
  }
}
```

### 2.3 类型安全最佳实践

- 避免使用 `any` 类型
- 使用 `unknown` 替代 `any`
- 使用类型断言时确保类型安全
- 优先使用类型推断
- 使用联合类型和交叉类型

## 3. 文件结构规范

### 3.1 目录结构

```
src/
├── components/          # React组件
│   ├── ui/             # 基础UI组件
│   └── features/       # 功能组件
├── lib/                # 工具库和业务逻辑
│   ├── api/            # API相关
│   ├── services/       # 业务服务
│   ├── utils/          # 工具函数
│   └── types/          # 类型定义
├── app/                # Next.js App Router
├── styles/             # 样式文件
└── public/             # 静态资源
```

### 3.2 文件组织原则

- 一个文件一个主要功能
- 相关功能放在同一目录
- 使用 index.ts 文件导出
- 避免过深的嵌套结构

## 4. 注释规范

### 4.1 JSDoc 注释

```typescript
/**
 * 用户服务类
 * 提供用户相关的业务逻辑处理
 */
export class UserService {
  /**
   * 根据ID获取用户信息
   * @param id 用户ID
   * @param includeProfile 是否包含详细信息
   * @returns Promise<User | null> 用户信息或null
   * @throws {ValidationError} 当ID无效时
   */
  async getUserById(
    id: number,
    includeProfile: boolean = false
  ): Promise<User | null> {
    // 实现逻辑
  }
}
```

### 4.2 行内注释

```typescript
// 计算用户积分，基于活跃度和贡献度
const userScore = calculateUserScore(user.activity, user.contributions);

// TODO: 优化算法性能，当前时间复杂度为O(n²)
const result = processLargeDataset(data);
```

### 4.3 注释原则

- 解释"为什么"而不是"做什么"
- 保持注释与代码同步
- 避免显而易见的注释
- 使用清晰的语法和标点

## 5. 错误处理规范

### 5.1 错误类型定义

```typescript
// 自定义错误类
export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// 错误类型枚举
export enum ErrorCode {
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  AUTHENTICATION_ERROR = 'AUTHENTICATION_ERROR',
  NOT_FOUND_ERROR = 'NOT_FOUND_ERROR',
  INTERNAL_ERROR = 'INTERNAL_ERROR',
}
```

### 5.2 错误处理模式

```typescript
// ✅ 推荐：明确的错误处理
try {
  const result = await riskyOperation();
  return result;
} catch (error) {
  if (error instanceof ValidationError) {
    throw new AppError('数据验证失败', ErrorCode.VALIDATION_ERROR, 400);
  }
  throw new AppError('操作失败', ErrorCode.INTERNAL_ERROR, 500);
}

// ✅ 推荐：使用 Result 模式
type Result<T, E = Error> =
  | { success: true; data: T }
  | { success: false; error: E };

async function safeOperation(): Promise<Result<string>> {
  try {
    const data = await operation();
    return { success: true, data };
  } catch (error) {
    return { success: false, error: error as Error };
  }
}
```

## 6. 代码质量规范

### 6.1 函数设计原则

- 单一职责原则
- 函数长度不超过50行
- 参数个数不超过5个
- 使用纯函数（避免副作用）

### 6.2 变量和常量

```typescript
// ✅ 推荐：使用 const
const API_BASE_URL = 'https://api.example.com';
const MAX_RETRY_COUNT = 3;

// ✅ 推荐：使用 let 当需要重新赋值
let currentPage = 1;
let isLoading = false;

// ❌ 避免：使用 var
var globalVariable = 'value';
```

### 6.3 导入和导出

```typescript
// ✅ 推荐：命名导出
export const UserService = {
  // ...
};

export function validateUser(user: User): boolean {
  // ...
}

// ✅ 推荐：统一导入
import { UserService, validateUser } from './user-service';
import type { User, UserRole } from './types';

// ❌ 避免：默认导出（除非必要）
export default class UserService {
  // ...
}
```

## 7. 测试规范

### 7.1 测试文件命名

- 单元测试: `*.test.ts`
- 集成测试: `*.integration.test.ts`
- E2E测试: `*.e2e.test.ts`

### 7.2 测试结构

```typescript
describe('UserService', () => {
  describe('getUserById', () => {
    it('should return user when valid ID provided', async () => {
      // Arrange
      const userId = 1;
      const expectedUser = { id: 1, name: 'John' };

      // Act
      const result = await UserService.getUserById(userId);

      // Assert
      expect(result).toEqual(expectedUser);
    });

    it('should throw error when invalid ID provided', async () => {
      // Arrange
      const invalidId = -1;

      // Act & Assert
      await expect(UserService.getUserById(invalidId)).rejects.toThrow(
        'Invalid user ID'
      );
    });
  });
});
```

## 8. Git 提交规范

### 8.1 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 8.2 类型说明

- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

### 8.3 示例

```
feat(auth): add JWT token validation

- Add JWT token validation middleware
- Implement token refresh mechanism
- Add unit tests for auth service

Closes #123
```

## 9. 代码审查规范

### 9.1 审查清单

- [ ] 代码符合命名规范
- [ ] 类型定义正确且完整
- [ ] 错误处理完善
- [ ] 注释清晰准确
- [ ] 测试覆盖充分
- [ ] 性能考虑合理
- [ ] 安全性检查通过

### 9.2 审查原则

- 保持建设性的反馈
- 关注代码质量而非个人偏好
- 提供具体的改进建议
- 及时响应审查请求

## 10. 性能优化规范

### 10.1 代码优化

- 避免不必要的计算
- 使用适当的数据结构
- 优化循环和递归
- 合理使用缓存

### 10.2 内存管理

- 及时释放资源
- 避免内存泄漏
- 使用弱引用（WeakMap, WeakSet）
- 监控内存使用

## 11. 安全规范

### 11.1 输入验证

```typescript
// ✅ 推荐：输入验证
function processUserInput(input: unknown): ProcessedInput {
  if (!isValidInput(input)) {
    throw new ValidationError('Invalid input');
  }
  return input as ProcessedInput;
}
```

### 11.2 敏感信息处理

- 不在代码中硬编码敏感信息
- 使用环境变量管理配置
- 加密存储敏感数据
- 定期更新密钥和证书

## 12. 工具配置

### 12.1 ESLint 配置

```json
{
  "extends": [
    "next/core-web-vitals",
    "next/typescript",
    "@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/no-unused-vars": "error",
    "prefer-const": "error",
    "no-var": "error"
  }
}
```

### 12.2 Prettier 配置

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2
}
```

## 13. 持续改进

### 13.1 定期审查

- 每月审查代码规范执行情况
- 收集团队反馈和建议
- 更新规范文档
- 分享最佳实践

### 13.2 工具集成

- 集成代码质量检查到CI/CD
- 使用自动化代码格式化
- 配置提交钩子检查
- 定期更新依赖和工具

---

## 附录

### A. 常用工具命令

```bash
# 代码检查
npm run lint

# 类型检查
npm run type-check

# 代码格式化
npm run format

# 测试
npm run test

# 构建
npm run build
```

### B. 参考资源

- [TypeScript 官方文档](https://www.typescriptlang.org/docs/)
- [ESLint 规则参考](https://eslint.org/docs/rules/)
- [Next.js 最佳实践](https://nextjs.org/docs)
- [React 代码规范](https://react.dev/learn)

---

_本文档将根据项目发展和团队反馈持续更新和完善。_
