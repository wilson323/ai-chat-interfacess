name: 代码质量检查

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 安装依赖
      run: npm ci

    - name: 类型检查
      run: npm run check-types

    - name: 代码规范检查
      run: npm run lint

    - name: 代码格式化检查
      run: npm run format:check

    - name: 运行测试
      run: npm run test

    - name: 构建检查
      run: npm run build

    - name: 安全检查
      run: npm audit --audit-level moderate

    - name: 质量监控
      run: node scripts/quality-monitor.js

    - name: 上传质量报告
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-report
        path: logs/quality-report.json
