---
description: æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ
globs: ["**/*.{ts,tsx,js,jsx,json,md}"]
alwaysApply: true
---

# æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

## ğŸš¨ å…³é”®æ³¨æ„äº‹é¡¹

### 1. ä»£ç è´¨é‡ç¦æ­¢é¡¹
- âŒ **ç¦æ­¢ä½¿ç”¨anyç±»å‹** - å¿…é¡»ä½¿ç”¨å…·ä½“ç±»å‹å®šä¹‰
- âŒ **ç¦æ­¢æœªå¤„ç†çš„Promise** - æ‰€æœ‰å¼‚æ­¥æ“ä½œå¿…é¡»æœ‰é”™è¯¯å¤„ç†
- âŒ **ç¦æ­¢ç¡¬ç¼–ç é…ç½®** - æ‰€æœ‰é…ç½®å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ç®¡ç†
- âŒ **ç¦æ­¢æœªæ³¨é‡Šçš„å¤æ‚é€»è¾‘** - å¤æ‚ä¸šåŠ¡é€»è¾‘å¿…é¡»æœ‰è¯¦ç»†æ³¨é‡Š
- âŒ **ç¦æ­¢é‡å¤ä»£ç ** - å‘ç°é‡å¤ä»£ç å¿…é¡»æå–ä¸ºå…¬å…±å‡½æ•°æˆ–ç»„ä»¶
- âŒ **ç¦æ­¢åŠŸèƒ½é‡å¤** - æ–°å¢åŠŸèƒ½å‰å¿…é¡»æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼åŠŸèƒ½

### 2. å®‰å…¨ç¦æ­¢é¡¹
- âŒ **ç¦æ­¢æ˜æ–‡å­˜å‚¨å¯†ç ** - å¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨
- âŒ **ç¦æ­¢è·³è¿‡è¾“å…¥éªŒè¯** - æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯
- âŒ **ç¦æ­¢æš´éœ²æ•æ„Ÿä¿¡æ¯** - æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯ä¸èƒ½åŒ…å«æ•æ„Ÿæ•°æ®
- âŒ **ç¦æ­¢ä½¿ç”¨ä¸å®‰å…¨çš„ä¾èµ–** - å®šæœŸæ›´æ–°ä¾èµ–ï¼Œæ‰«æå®‰å…¨æ¼æ´

### 3. æ€§èƒ½ç¦æ­¢é¡¹
- âŒ **ç¦æ­¢åŒæ­¥é˜»å¡æ“ä½œ** - é•¿æ—¶é—´æ“ä½œå¿…é¡»å¼‚æ­¥å¤„ç†
- âŒ **ç¦æ­¢å†…å­˜æ³„æ¼** - ç»„ä»¶å¸è½½æ—¶å¿…é¡»æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨
- âŒ **ç¦æ­¢è¿‡å¤§çš„bundleæ–‡ä»¶** - ä½¿ç”¨ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
- âŒ **ç¦æ­¢æœªä¼˜åŒ–çš„å›¾ç‰‡** - å›¾ç‰‡å¿…é¡»å‹ç¼©å’Œæ ¼å¼ä¼˜åŒ–

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç»„ä»¶è®¾è®¡æœ€ä½³å®è·µ

#### ç»„ä»¶èŒè´£å•ä¸€
```typescript
// âœ… å¥½çš„è®¾è®¡ - å•ä¸€èŒè´£
interface UserProfileProps {
  userId: string
  onUpdate?: (user: User) => void
}

export function UserProfile({ userId, onUpdate }: UserProfileProps) {
  // åªè´Ÿè´£æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
}

// âŒ ä¸å¥½çš„è®¾è®¡ - èŒè´£è¿‡å¤š
export function UserProfileAndSettings({ userId }: { userId: string }) {
  // æ—¢æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼Œåˆå¤„ç†è®¾ç½®ï¼Œè¿˜ç®¡ç†çŠ¶æ€
}
```

#### ç»„ä»¶å¯å¤ç”¨æ€§
```typescript
// âœ… å¥½çš„è®¾è®¡ - é«˜åº¦å¯å¤ç”¨
interface ButtonProps {
  variant?: 'primary' | 'secondary' | 'danger'
  size?: 'sm' | 'md' | 'lg'
  disabled?: boolean
  children: React.ReactNode
  onClick?: () => void
  className?: string
}

// âŒ ä¸å¥½çš„è®¾è®¡ - ç¡¬ç¼–ç ï¼Œä¸å¯å¤ç”¨
export function LoginButton() {
  return <button className="bg-blue-500 text-white px-4 py-2">Login</button>
}
```

#### ç»„ä»¶å¯æµ‹è¯•æ€§
```typescript
// âœ… å¥½çš„è®¾è®¡ - æ˜“äºæµ‹è¯•
export function Counter({ initialValue = 0, onCountChange }: CounterProps) {
  const [count, setCount] = useState(initialValue)
  
  const increment = () => {
    const newCount = count + 1
    setCount(newCount)
    onCountChange?.(newCount)
  }
  
  return (
    <div>
      <span data-testid="count">{count}</span>
      <button data-testid="increment" onClick={increment}>+</button>
    </div>
  )
}

// âŒ ä¸å¥½çš„è®¾è®¡ - éš¾ä»¥æµ‹è¯•
export function Counter() {
  const [count, setCount] = useState(0)
  
  return (
    <div>
      <span>{count}</span>
      <button onClick={() => setCount(count + 1)}>+</button>
    </div>
  )
}
```

### 2. çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

#### çŠ¶æ€æå‡
```typescript
// âœ… å¥½çš„è®¾è®¡ - çŠ¶æ€æå‡åˆ°åˆé€‚çš„å±‚çº§
export function ChatContainer() {
  const [messages, setMessages] = useState<Message[]>([])
  const [currentAgent, setCurrentAgent] = useState<Agent | null>(null)
  
  return (
    <div>
      <AgentSelector 
        currentAgent={currentAgent}
        onAgentChange={setCurrentAgent}
      />
      <MessageList messages={messages} />
      <MessageInput 
        onSendMessage={(message) => {
          setMessages(prev => [...prev, message])
        }}
      />
    </div>
  )
}

// âŒ ä¸å¥½çš„è®¾è®¡ - çŠ¶æ€åˆ†æ•£
export function MessageInput() {
  const [messages, setMessages] = useState<Message[]>([]) // çŠ¶æ€åº”è¯¥åœ¨çˆ¶ç»„ä»¶
  // ...
}
```

#### çŠ¶æ€æ›´æ–°ä¼˜åŒ–
```typescript
// âœ… å¥½çš„è®¾è®¡ - ä½¿ç”¨å‡½æ•°å¼æ›´æ–°
setMessages(prev => [...prev, newMessage])

// âœ… å¥½çš„è®¾è®¡ - ä½¿ç”¨useCallbackä¼˜åŒ–
const handleSendMessage = useCallback((message: string) => {
  setMessages(prev => [...prev, { id: Date.now(), content: message }])
}, [])

// âŒ ä¸å¥½çš„è®¾è®¡ - ç›´æ¥ä¾èµ–çŠ¶æ€
const handleSendMessage = (message: string) => {
  setMessages([...messages, { id: Date.now(), content: message }])
}
```

### 3. APIè®¾è®¡æœ€ä½³å®è·µ

#### ç»Ÿä¸€é”™è¯¯å¤„ç†
```typescript
// âœ… å¥½çš„è®¾è®¡ - ç»Ÿä¸€é”™è¯¯å¤„ç†
export class ApiError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 500,
    public details?: any
  ) {
    super(message)
    this.name = 'ApiError'
  }
}

export async function apiRequest<T>(url: string, options?: RequestInit): Promise<T> {
  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options?.headers
      }
    })
    
    if (!response.ok) {
      const errorData = await response.json()
      throw new ApiError(
        errorData.error?.code || 'API_ERROR',
        errorData.error?.message || 'Request failed',
        response.status,
        errorData.error?.details
      )
    }
    
    return await response.json()
  } catch (error) {
    if (error instanceof ApiError) {
      throw error
    }
    throw new ApiError('NETWORK_ERROR', 'Network request failed', 0, error)
  }
}
```

#### è¯·æ±‚é‡è¯•æœºåˆ¶
```typescript
// âœ… å¥½çš„è®¾è®¡ - è¯·æ±‚é‡è¯•æœºåˆ¶
export async function apiRequestWithRetry<T>(
  url: string, 
  options?: RequestInit,
  maxRetries: number = 3
): Promise<T> {
  let lastError: Error
  
  for (let i = 0; i <= maxRetries; i++) {
    try {
      return await apiRequest<T>(url, options)
    } catch (error) {
      lastError = error as Error
      
      // å¦‚æœæ˜¯å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¸é‡è¯•
      if (error instanceof ApiError && error.statusCode < 500) {
        throw error
      }
      
      // ç­‰å¾…åé‡è¯•
      if (i < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000))
      }
    }
  }
  
  throw lastError!
}
```

### 4. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

#### ä»£ç åˆ†å‰²
```typescript
// âœ… å¥½çš„è®¾è®¡ - ä»£ç åˆ†å‰²
const CADAnalyzer = lazy(() => import('@/components/cad-analyzer/cad-analyzer-container'))
const ImageEditor = lazy(() => import('@/components/image-editor/image-editor'))

export function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/cad" element={<CADAnalyzer />} />
        <Route path="/image" element={<ImageEditor />} />
      </Routes>
    </Suspense>
  )
}
```

#### å›¾ç‰‡ä¼˜åŒ–
```typescript
// âœ… å¥½çš„è®¾è®¡ - å›¾ç‰‡ä¼˜åŒ–
export function OptimizedImage({ src, alt, ...props }: ImageProps) {
  const [isLoaded, setIsLoaded] = useState(false)
  const [error, setError] = useState(false)
  
  return (
    <div className="relative">
      {!isLoaded && !error && (
        <div className="absolute inset-0 bg-gray-200 animate-pulse" />
      )}
      <img
        src={src}
        alt={alt}
        loading="lazy"
        onLoad={() => setIsLoaded(true)}
        onError={() => setError(true)}
        className={`transition-opacity duration-300 ${
          isLoaded ? 'opacity-100' : 'opacity-0'
        }`}
        {...props}
      />
      {error && (
        <div className="absolute inset-0 flex items-center justify-center bg-gray-100">
          <span className="text-gray-500">å›¾ç‰‡åŠ è½½å¤±è´¥</span>
        </div>
      )}
    </div>
  )
}
```

#### å†…å­˜æ³„æ¼é˜²æŠ¤
```typescript
// âœ… å¥½çš„è®¾è®¡ - é˜²æ­¢å†…å­˜æ³„æ¼
export function useWebSocket(url: string) {
  const [socket, setSocket] = useState<WebSocket | null>(null)
  const [isConnected, setIsConnected] = useState(false)
  
  useEffect(() => {
    const ws = new WebSocket(url)
    
    ws.onopen = () => setIsConnected(true)
    ws.onclose = () => setIsConnected(false)
    ws.onerror = (error) => console.error('WebSocket error:', error)
    
    setSocket(ws)
    
    // æ¸…ç†å‡½æ•°
    return () => {
      ws.close()
      setSocket(null)
    }
  }, [url])
  
  return { socket, isConnected }
}
```

### 5. å®‰å…¨æœ€ä½³å®è·µ

#### è¾“å…¥éªŒè¯
```typescript
// âœ… å¥½çš„è®¾è®¡ - ä¸¥æ ¼çš„è¾“å…¥éªŒè¯
import { z } from 'zod'

const UserInputSchema = z.object({
  name: z.string()
    .min(1, 'å§“åä¸èƒ½ä¸ºç©º')
    .max(100, 'å§“åä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦')
    .regex(/^[\u4e00-\u9fa5a-zA-Z\s]+$/, 'å§“ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡å’Œç©ºæ ¼'),
  email: z.string()
    .email('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®')
    .max(255, 'é‚®ç®±ä¸èƒ½è¶…è¿‡255ä¸ªå­—ç¬¦'),
  age: z.number()
    .int('å¹´é¾„å¿…é¡»æ˜¯æ•´æ•°')
    .min(0, 'å¹´é¾„ä¸èƒ½å°äº0')
    .max(150, 'å¹´é¾„ä¸èƒ½è¶…è¿‡150')
})

export async function validateUserInput(input: unknown) {
  try {
    return UserInputSchema.parse(input)
  } catch (error) {
    if (error instanceof z.ZodError) {
      throw new ValidationError('è¾“å…¥æ•°æ®éªŒè¯å¤±è´¥', error.errors)
    }
    throw error
  }
}
```

#### XSSé˜²æŠ¤
```typescript
// âœ… å¥½çš„è®¾è®¡ - XSSé˜²æŠ¤
import DOMPurify from 'dompurify'

export function SafeHTML({ content }: { content: string }) {
  const sanitizedContent = DOMPurify.sanitize(content, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: []
  })
  
  return (
    <div 
      dangerouslySetInnerHTML={{ __html: sanitizedContent }}
      className="prose"
    />
  )
}
```

### 6. æµ‹è¯•æœ€ä½³å®è·µ

#### æµ‹è¯•è¦†ç›–ç‡
```typescript
// âœ… å¥½çš„è®¾è®¡ - å…¨é¢çš„æµ‹è¯•è¦†ç›–
describe('UserService', () => {
  describe('createUser', () => {
    it('should create user with valid data', async () => {
      // æ­£å¸¸æƒ…å†µæµ‹è¯•
    })
    
    it('should throw error with invalid email', async () => {
      // è¾¹ç•Œæ¡ä»¶æµ‹è¯•
    })
    
    it('should throw error with duplicate email', async () => {
      // å¼‚å¸¸æƒ…å†µæµ‹è¯•
    })
    
    it('should handle database connection error', async () => {
      // é”™è¯¯æƒ…å†µæµ‹è¯•
    })
  })
})
```

#### æµ‹è¯•æ•°æ®ç®¡ç†
```typescript
// âœ… å¥½çš„è®¾è®¡ - æµ‹è¯•æ•°æ®ç®¡ç†
export const testData = {
  validUser: {
    name: 'Test User',
    email: 'test@example.com',
    password: 'password123'
  },
  invalidUser: {
    name: '',
    email: 'invalid-email',
    password: '123'
  }
}

export function createTestUser(overrides: Partial<User> = {}) {
  return {
    id: 'test-user-id',
    name: 'Test User',
    email: 'test@example.com',
    createdAt: new Date(),
    updatedAt: new Date(),
    ...overrides
  }
}
```

## ğŸ”§ å·¥å…·å’Œé…ç½®

### ESLinté…ç½®
```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/no-unused-vars": "error",
    "prefer-const": "error",
    "no-var": "error"
  }
}
```

### Prettieré…ç½®
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false
}
```

### TypeScripté…ç½®
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  }
}
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### é”™è¯¯ç›‘æ§
```typescript
// âœ… å¥½çš„è®¾è®¡ - é”™è¯¯ç›‘æ§
export function withErrorBoundary<T extends React.ComponentType<any>>(
  Component: T
) {
  return function ErrorBoundaryComponent(props: React.ComponentProps<T>) {
    return (
      <ErrorBoundary
        fallback={<ErrorFallback />}
        onError={(error, errorInfo) => {
          // å‘é€é”™è¯¯åˆ°ç›‘æ§æœåŠ¡
          console.error('Component Error:', error, errorInfo)
        }}
      >
        <Component {...props} />
      </ErrorBoundary>
    )
  }
}
```

### æ€§èƒ½ç›‘æ§
```typescript
// âœ… å¥½çš„è®¾è®¡ - æ€§èƒ½ç›‘æ§
export function usePerformanceMonitor(componentName: string) {
  useEffect(() => {
    const startTime = performance.now()
    
    return () => {
      const endTime = performance.now()
      const duration = endTime - startTime
      
      if (duration > 100) {
        console.warn(`${componentName} render took ${duration}ms`)
      }
    }
  })
}
```

---

## âš ï¸ é‡è¦æé†’

1. **æŒç»­å­¦ä¹ **: æŠ€æœ¯æ ˆä¸æ–­æ›´æ–°ï¼Œä¿æŒå­¦ä¹ æœ€æ–°æœ€ä½³å®è·µ
2. **ä»£ç å®¡æŸ¥**: æ¯æ¬¡ä»£ç å˜æ›´éƒ½è¦ç»è¿‡åŒè¡Œå®¡æŸ¥
3. **è‡ªåŠ¨åŒ–æµ‹è¯•**: å»ºç«‹å®Œå–„çš„è‡ªåŠ¨åŒ–æµ‹è¯•ä½“ç³»
4. **æ€§èƒ½ç›‘æ§**: æŒç»­ç›‘æ§åº”ç”¨æ€§èƒ½ï¼ŒåŠæ—¶ä¼˜åŒ–
5. **å®‰å…¨å®¡è®¡**: å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡ï¼Œä¿®å¤æ¼æ´

**è®°ä½: å¥½çš„ä»£ç æ˜¯å†™å‡ºæ¥çš„ï¼Œä¸æ˜¯æ”¹å‡ºæ¥çš„ã€‚ä»è®¾è®¡é˜¶æ®µå°±è¦è€ƒè™‘è´¨é‡ã€æ€§èƒ½å’Œå®‰å…¨ã€‚**