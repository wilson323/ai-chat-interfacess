# 智能体切换问题修复 - 测试计划

## 问题描述
在一个智能体正在回复（流式响应进行中）的过程中，如果用户切换到另一个智能体，原来的流式响应会继续在新智能体的界面中显示。

## 修复方案概述
实现了完整的请求中断机制和状态清理系统：

### 1. AgentContext 增强
- 添加了 `abortCurrentRequest` 函数
- 添加了 `setAbortController` 函数  
- 添加了 `isRequestActive` 状态跟踪
- 在 `selectAgent` 中添加了请求中断和事件发送

### 2. ChatContainer 状态清理
- 添加了智能体切换监听 (`agent-switching` 事件)
- 实现了统一的 AbortController 管理
- 添加了智能体验证机制
- 增强了错误处理

### 3. 流式响应回调保护
- 在所有回调中添加了智能体验证
- 实现了请求状态跟踪
- 添加了 AbortError 特殊处理

## 测试用例

### 基本功能测试

#### 测试用例 1：正常智能体切换
**步骤：**
1. 选择智能体A
2. 发送一条消息
3. 等待回复完成
4. 切换到智能体B
5. 发送另一条消息

**预期结果：**
- 智能体A的回复正常完成
- 切换到智能体B后界面清空
- 智能体B的回复正常显示

#### 测试用例 2：回复过程中切换智能体
**步骤：**
1. 选择智能体A
2. 发送一条消息
3. 在智能体A回复过程中（流式响应进行时）立即切换到智能体B
4. 观察界面变化

**预期结果：**
- 智能体A的流式响应立即停止
- 界面清空，不显示智能体A的部分回复
- 智能体B的界面干净，无污染
- 控制台显示"中断当前请求"和"智能体已切换，忽略 xxx 回调"日志

#### 测试用例 3：快速连续切换
**步骤：**
1. 选择智能体A
2. 发送消息
3. 在回复过程中快速切换到智能体B
4. 立即再切换到智能体C
5. 再切换回智能体A

**预期结果：**
- 每次切换都能正确中断前一个请求
- 最终显示的智能体界面干净
- 无交叉污染

### 边界情况测试

#### 测试用例 4：思考过程中切换
**步骤：**
1. 选择一个会显示思考过程的智能体
2. 发送复杂问题
3. 在思考过程显示时切换智能体

**预期结果：**
- 思考过程立即停止
- 新智能体界面无残留的思考信息

#### 测试用例 5：交互节点出现时切换
**步骤：**
1. 选择有交互节点的智能体
2. 触发交互节点
3. 在交互选项显示时切换智能体

**预期结果：**
- 交互节点立即消失
- 新智能体界面无交互残留

#### 测试用例 6：网络错误时切换
**步骤：**
1. 断开网络
2. 发送消息触发错误
3. 在错误处理过程中切换智能体

**预期结果：**
- 错误处理正常中断
- 新智能体界面正常

### 性能测试

#### 测试用例 7：内存泄漏检查
**步骤：**
1. 连续切换智能体50次
2. 每次切换都发送消息并立即切换
3. 检查浏览器内存使用

**预期结果：**
- 内存使用稳定，无明显泄漏
- AbortController 正确释放

#### 测试用例 8：事件监听器清理
**步骤：**
1. 多次进入和离开聊天页面
2. 检查事件监听器是否正确清理

**预期结果：**
- 无重复的事件监听器
- 组件卸载时正确清理

## 验收标准

### 功能验收
- ✅ 智能体切换时，前一个智能体的流式响应立即停止
- ✅ 新智能体的界面完全干净，无前一个智能体的内容残留  
- ✅ 快速连续切换智能体不会导致界面混乱
- ✅ 正常的对话流程不受影响
- ✅ 错误处理机制完善，用户体验良好

### 技术验收
- ✅ AbortController 正确创建和销毁
- ✅ 事件监听器正确注册和清理
- ✅ 智能体验证机制工作正常
- ✅ 请求状态跟踪准确
- ✅ 无内存泄漏和性能问题

## 调试信息

### 关键日志
在测试过程中，应该能看到以下关键日志：

```
// 智能体切换时
智能体切换: 智能体A -> 智能体B
中断当前请求
中断流式请求

// 回调保护时
智能体已切换，忽略 onStart 回调
智能体已切换，忽略 onChunk 回调  
智能体已切换，忽略 onIntermediateValue 回调
智能体已切换，忽略 onFinish 回调

// 请求中断时
流式请求被中断
请求被用户中断
```

### 检查点
1. 控制台无错误信息
2. 网络面板中被中断的请求状态为 "cancelled"
3. React DevTools 中组件状态正确更新
4. 内存使用稳定

## 回归测试

确保修复没有影响现有功能：
- 正常对话流程
- 文件上传功能
- 语音输入功能
- 历史记录功能
- 全局变量配置
- CAD解析功能
- 主题切换功能
