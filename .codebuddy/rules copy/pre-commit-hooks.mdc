---
alwaysApply: true
description: Pre-commité’©å­å’Œä»£ç è´¨é‡é—¨æ§
---

# Pre-commité’©å­å’Œä»£ç è´¨é‡é—¨æ§

## æ ¸å¿ƒåŸåˆ™
- æ¯ä¸ªé˜¶æ®µè½å®å¥½ä¸”ä¹Ÿæµ‹è¯•éªŒè¯åè¯·è‡ªåŠ¨æäº¤git
- ç¦æ­¢ä»£ç ç»„ä»¶åŠŸèƒ½ç­‰çš„å†—ä½™
- æ–°å¢å‰å…ˆå…¨å±€æ¢³ç†ç¡®ä¿ä¸å†—ä½™å†å»æ–°å¢
- å»ºç«‹å®Œæ•´çš„ä»£ç è´¨é‡é—¨æ§æœºåˆ¶

## Huskyé…ç½®

### å®‰è£…å’Œé…ç½®
```bash
# å®‰è£…Husky
npm install --save-dev husky

# åˆå§‹åŒ–Husky
npx husky init

# è®¾ç½®pre-commité’©å­
echo "npm run pre-commit" > .husky/pre-commit
chmod +x .husky/pre-commit
```

### Pre-commité’©å­è„šæœ¬
```bash
#!/bin/bash
echo "ğŸ” å¼€å§‹Pre-commitæ£€æŸ¥..."

# 1. ç±»å‹æ£€æŸ¥
echo "ğŸ“‹ è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
npm run check-types
if [ $? -ne 0 ]; then
  echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
  exit 1
fi

# 2. ä»£ç è§„èŒƒæ£€æŸ¥
echo "ğŸ“‹ è¿è¡ŒESLintæ£€æŸ¥..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ä»£ç è§„èŒƒæ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
  exit 1
fi

# 3. æ ¼å¼åŒ–æ£€æŸ¥
echo "ğŸ“‹ è¿è¡ŒPrettieræ£€æŸ¥..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ ä»£ç æ ¼å¼åŒ–æ£€æŸ¥å¤±è´¥ï¼Œè¯·è¿è¡Œ npm run format ä¿®å¤"
  exit 1
fi

# 4. æµ‹è¯•è¿è¡Œ
echo "ğŸ“‹ è¿è¡Œæµ‹è¯•..."
npm run test
if [ $? -ne 0 ]; then
  echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
  exit 1
fi

# 5. æ„å»ºæ£€æŸ¥
echo "ğŸ“‹ è¿è¡Œæ„å»ºæ£€æŸ¥..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
  exit 1
fi

echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥æäº¤"
```

## Lint-stagedé…ç½®

### é…ç½®æ–‡ä»¶
```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ],
    "*.{js,jsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ],
    "*.{json,md,css}": [
      "prettier --write",
      "git add"
    ]
  }
}
```

### è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™
```javascript
// lint-staged.config.js
module.exports = {
  '*.{ts,tsx}': [
    // 1. ç±»å‹æ£€æŸ¥
    'tsc --noEmit',

    // 2. ESLintæ£€æŸ¥
    'eslint --fix',

    // 3. Prettieræ ¼å¼åŒ–
    'prettier --write',

    // 4. è‡ªå®šä¹‰æ£€æŸ¥
    'node scripts/check-jsx-special-chars.js',

    // 5. æ·»åŠ åˆ°æš‚å­˜åŒº
    'git add'
  ],
  '*.{js,jsx}': [
    'eslint --fix',
    'prettier --write',
    'git add'
  ],
  '*.{json,md,css}': [
    'prettier --write',
    'git add'
  ]
};
```

## è‡ªå®šä¹‰æ£€æŸ¥è„šæœ¬

### JSXç‰¹æ®Šå­—ç¬¦æ£€æŸ¥
```javascript
// scripts/check-jsx-special-chars.js
const fs = require('fs');
const path = require('path');

function checkJsxSpecialChars(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');
  const htmlEntities = /&[a-zA-Z0-9#]+;/g;
  const matches = content.match(htmlEntities);

  if (matches) {
    console.error(`âŒ å‘ç°HTMLå®ä½“ç¼–ç : ${filePath}`);
    console.error(`   å®ä½“ç¼–ç : ${matches.join(', ')}`);
    console.error(`   è¯·ä½¿ç”¨JavaScriptè¡¨è¾¾å¼: {'<'} ä»£æ›¿ &lt;`);
    return false;
  }

  return true;
}

function checkFiles() {
  const files = process.argv.slice(2);
  let hasErrors = false;

  files.forEach(file => {
    if (file.endsWith('.tsx') || file.endsWith('.jsx')) {
      if (!checkJsxSpecialChars(file)) {
        hasErrors = true;
      }
    }
  });

  if (hasErrors) {
    process.exit(1);
  }

  console.log('âœ… JSXç‰¹æ®Šå­—ç¬¦æ£€æŸ¥é€šè¿‡');
}

checkFiles();
```

### ä»£ç é‡å¤æ£€æŸ¥
```javascript
// scripts/check-code-duplication.js
const fs = require('fs');
const path = require('path');

function checkCodeDuplication() {
  console.log('ğŸ” æ£€æŸ¥ä»£ç é‡å¤...');

  // ä½¿ç”¨jscpdæ£€æŸ¥ä»£ç é‡å¤
  const { exec } = require('child_process');

  exec('npx jscpd --min-lines 5 --min-tokens 50 src/', (error, stdout, stderr) => {
    if (error) {
      console.error('âŒ å‘ç°ä»£ç é‡å¤');
      console.error(stderr);
      process.exit(1);
    }

    console.log('âœ… ä»£ç é‡å¤æ£€æŸ¥é€šè¿‡');
  });
}

checkCodeDuplication();
```

## è´¨é‡é—¨æ§é…ç½®

### è´¨é‡é—¨æ§è§„åˆ™
```javascript
// scripts/quality-gate.js
const qualityGate = {
  // ç±»å‹æ£€æŸ¥
  typeCheck: {
    required: true,
    command: 'npm run check-types',
    threshold: 0 // 0ä¸ªé”™è¯¯
  },

  // ä»£ç è§„èŒƒ
  lint: {
    required: true,
    command: 'npm run lint',
    threshold: 0 // 0ä¸ªé”™è¯¯
  },

  // æµ‹è¯•è¦†ç›–ç‡
  testCoverage: {
    required: true,
    command: 'npm run test:coverage',
    threshold: 80 // 80%è¦†ç›–ç‡
  },

  // æ„å»ºæ£€æŸ¥
  build: {
    required: true,
    command: 'npm run build',
    threshold: 0 // 0ä¸ªé”™è¯¯
  }
};

module.exports = qualityGate;
```

### è´¨é‡é—¨æ§æ‰§è¡Œ
```javascript
// scripts/run-quality-gate.js
const qualityGate = require('./quality-gate');
const { exec } = require('child_process');

async function runQualityGate() {
  console.log('ğŸšª å¼€å§‹è´¨é‡é—¨æ§æ£€æŸ¥...');

  for (const [name, config] of Object.entries(qualityGate)) {
    if (!config.required) continue;

    console.log(`ğŸ“‹ è¿è¡Œ ${name} æ£€æŸ¥...`);

    try {
      await runCommand(config.command);
      console.log(`âœ… ${name} æ£€æŸ¥é€šè¿‡`);
    } catch (error) {
      console.error(`âŒ ${name} æ£€æŸ¥å¤±è´¥`);
      console.error(error.message);
      process.exit(1);
    }
  }

  console.log('ğŸ‰ æ‰€æœ‰è´¨é‡é—¨æ§æ£€æŸ¥é€šè¿‡');
}

function runCommand(command) {
  return new Promise((resolve, reject) => {
    exec(command, (error, stdout, stderr) => {
      if (error) {
        reject(new Error(stderr));
      } else {
        resolve(stdout);
      }
    });
  });
}

runQualityGate();
```

## æäº¤ä¿¡æ¯è§„èŒƒ

### æäº¤ä¿¡æ¯æ¨¡æ¿
```bash
# .gitmessage
# <type>(<scope>): <subject>
#
# <body>
#
# <footer>

# ç±»å‹è¯´æ˜
# feat:     æ–°åŠŸèƒ½
# fix:      ä¿®å¤é—®é¢˜
# docs:     æ–‡æ¡£æ›´æ–°
# style:    ä»£ç æ ¼å¼
# refactor: é‡æ„ä»£ç 
# test:     æµ‹è¯•ç›¸å…³
# chore:    æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨

# èŒƒå›´è¯´æ˜
# admin:    ç®¡ç†ç•Œé¢
# api:      APIç›¸å…³
# ui:       ç”¨æˆ·ç•Œé¢
# lib:      å·¥å…·åº“
# types:    ç±»å‹å®šä¹‰
# tests:    æµ‹è¯•ç›¸å…³

# ä¸»é¢˜è¯´æ˜
# 50å­—ç¬¦ä»¥å†…ï¼Œæè¿°ä¸»è¦å˜æ›´

# æ­£æ–‡è¯´æ˜
# 72å­—ç¬¦æ¢è¡Œï¼Œæè¿°è¯¦ç»†å˜æ›´

# é¡µè„šè¯´æ˜
# å…³è”issueï¼Œç ´åæ€§å˜æ›´ç­‰
```

### æäº¤ä¿¡æ¯æ£€æŸ¥
```javascript
// scripts/check-commit-message.js
const fs = require('fs');

function checkCommitMessage() {
  const commitMessage = fs.readFileSync(process.argv[2], 'utf8');

  // æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼
  const commitRegex = /^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .{1,50}$/;

  if (!commitRegex.test(commitMessage.split('\n')[0])) {
    console.error('âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸æ­£ç¡®');
    console.error('   æ ¼å¼: <type>(<scope>): <subject>');
    console.error('   ç±»å‹: feat, fix, docs, style, refactor, test, chore');
    console.error('   èŒƒå›´: admin, api, ui, lib, types, tests');
    console.error('   ä¸»é¢˜: 50å­—ç¬¦ä»¥å†…');
    process.exit(1);
  }

  console.log('âœ… æäº¤ä¿¡æ¯æ ¼å¼æ­£ç¡®');
}

checkCommitMessage();
```

## æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ
- [ ] Huskyé…ç½®æ­£ç¡®
- [ ] Lint-stagedé…ç½®å®Œæ•´
- [ ] è‡ªå®šä¹‰æ£€æŸ¥è„šæœ¬æœ‰æ•ˆ
- [ ] è´¨é‡é—¨æ§è§„åˆ™è®¾ç½®
- [ ] æäº¤ä¿¡æ¯è§„èŒƒé…ç½®

### æ„å»ºé˜¶æ®µ
- [ ] Pre-commité’©å­ç”Ÿæ•ˆ
- [ ] è‡ªåŠ¨ä¿®å¤åŠŸèƒ½æ­£å¸¸
- [ ] è´¨é‡é—¨æ§é€šè¿‡
- [ ] æäº¤ä¿¡æ¯æ£€æŸ¥é€šè¿‡
- [ ] æ„å»ºæµç¨‹å®Œæ•´

### æŒç»­é›†æˆ
- [ ] CI/CDé›†æˆé…ç½®
- [ ] è´¨é‡é—¨æ§é›†æˆ
- [ ] è‡ªåŠ¨ä¿®å¤é›†æˆ
- [ ] ç›‘æ§å‘Šè­¦é…ç½®
- [ ] å›æ»šæœºåˆ¶è®¾ç½®

å‚è€ƒé…ç½®æ–‡ä»¶ï¼š[package.json](mdc:package.json), [.husky](mdc:.husky)
